{{< include macros.qmd >}}

# Arbitrage and Trees {#sec-c:intro_arbitrage} 

```{python}
#| eval: true
#| echo: false

import plotly
from IPython.display import display, HTML

plotly.offline.init_notebook_mode(connected=True)
display(
    HTML(
        '<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_SVG"></script>'
    )
)
```



This chapter introduces the change of measure (or change of numeraire or martingale)  method for valuing derivative securities.  The method is illustrated in a finite-state model and then extended to more general (continuum of states) models.  

The pricing and hedging results in this book are not tied to any particular currency.  However, for specificity, the discussion will generally be in terms of dollars.  

## Fundamental Ideas

The fundamental concept underlying most finance theory, from Miller-Modigliani to the Black Scholes model, is linear pricing.  The concept of linear pricing is essentially the same as asking what is the price of five apples and six oranges.  Of course, this is the price of one apple times five plus the price of one orange times six.  However, instead of pricing bundles of commodities today, we will find prices of dollars in different contigencies at times in the future.  

An arbitrage opportunity is a trading strategy that produces nonnegative cash flows at all times in all contingencies with a strictly positive cash flow at some time in some contingency.  If such an opportunity were to exist, traders would exploit it until prices adjust to eliminate this possibility.  Although simple, this has powerful implications. 

Consider a world where there are $J$ possible states of the world at timme $t$.  No arbritrage then implies the following properties.

1.  If $X$ and $Y$ are time $t$ random cash flows, the time 0 price today of the random cash flow $aX+bY$ is t $a$ times the time 0 price of $X$ plus $b$ times the time zero price of $Y$.  If $P(\cdot)$ is a pricing function that gives us the price of a random cash flow today, then $P(aA+bB)=aP(A) + bP(B)$.  In other words, the pricing operator is linear.  This follows because if this fails to hold, there is an arbitrage assuming an agent can buy and sell any quantities at these prices.  Because the pricing operator is linear, it must have the form $P(X) = \sum_{j=1}^J \pi_j X_j$ where $X_j$ si the random cash flow in state~$j$.  We call $\pi_j$ the price of a dollar at time $t$ in state $j$ or a state price.

2.  The price of any positive nonzero random cash flow at time $t$ is strictly positive.  Again, this follows from no arbitrage (think how much of an asset paying a positive dividend you would want if it were free or even if you were paid to take the asset).  This implies the state prices are strictly positive.

3.  The pricing operator obeys time value of money: $1=\sum_{j=1}^J \pi_j e^{rt}$, where $r$ is the continuously compounded yield to maturity of a bond maturing at $t$.  This is the present value rule, in other words, the present value of the future value $e^{rt}$ is one or, equivalently, the present value of a dollar paid at $t$ is $e^{-rt}$.

4.  The pricing operator must be consistent with observable prices.  The price $S_0$ of a traded asset with random cash flows at time $t$ is given by $S_0= \sum_{j=1}^J \pi_j S_j$ where $S_j$ is the random cash flow in state $j$.


::: Principle
In the absence of arbitrage opportunities, there exist positive state prices such that the price of any security is the sum across the states of the world of its payoff multiplied by the state price.
:::

This conclusion generalizes to other models, including models in which the stock price takes a continuum of possible values, interpreting **sum** in that case as an integral.  We discuss more general models later in this chapter.

We can think of any security as a portfolio of what are called Arrow securities (in recognition of the seminal work of Kenneth Arrow [@Arrow]). An Arrow security’s payoff is tied to a specific state of the world, paying \$1 at time t if the state in question occurs and paying nothing otherwise. State prices are the prices of these Arrow securities, and, given these state prices, we can value any security.  The state prices can be found by inverting the pricing relationship for prices of traded securities;  in other words use traded securities to find the prices of securities that pay off a dollar in each time/state contingency.  While in general this can be challenging, the procedure is easily illlustrated in the binomial model that we examine next.

#### Fundamental Ideas in a Simple Setting {#sec-s:oneperiodbinomial}

In this section we consider the following very simple framework.  \index{binomial model} There is a stock with price $S$ today (which we call date $0$).  At the end of some period of time of length $t$, the stock price will take one of two values: either $S_u$ or $S_d$, where $S_u > S_d$.  If the stock price equals $S_u$, we say we are in the up state of the world, and, if it equals $S_d$, we say we are in the down state.  The stock does not pay a dividend prior to $t$.  There is also a risk-free asset earning a continuously compounded rate of interest $r$.  

We can relax the assumption that the stock does not pay a dividend prior to $t$.  We do that by assuming we are enrolled in a dividend-reinvestment program, so we receive additional shares of the asset instead of receiving cash dividends.   If a company does not operate a dividend-reinvestment program, then we can simulate one on our own by buying shares with cash dividends received.  In our model, we start with one share at date $0$ with price $S_0$, and we consider the future value -- either $S_u$ or $S_d$ -- of owning more than one share at date $t$, because the number of shares grows through reinvestment of dividends.   We call this future value a **dividend-reinvested asset price” because of this property, and we formulate valuation principles for such assets throughout the book.

Assume
$$
\frac{S_u}{S} > \mathrm{e}^{rt} > \frac{S_d}{S}\;.
$$ {#eq-binomialnoarbitrage}
This condition means that the rate of return on the stock in the up state is greater than the risk-free rate, and the rate of return on the stock in the down state is less than the risk-free rate.  If it were not true, there would be an arbitrage opportunity: if the rate of return on the stock were greater than the risk-free rate in both states, then one should buy an infinite amount of the stock on margin, and conversely if the rate of return on the stock were less than the risk-free rate in both states, then one should short an infinite amount of stock and put the proceeds in the risk-free asset.  So what we are assuming is that there are no arbitrage opportunities in the market for the stock and risk-free asset.

####  State prices 

It is a simple matter to solve for state prices in this model.  We have two equations and two unknowns.  
$$ 1 = \pi_u e^{rt} + \pi_d e^{rt} $$
$$ S = \pi_u S_u + \pi_d S_d $$

Solving these equations gives $\pi_u  = \frac{S-e^{-rt}S_d}{S_u - S_d}$ and $\pi_d = \frac{e^{-rt}S_u-S}{S_u - S_d}$.  Notice the requirement that $\pi_s > 0$ is precisely the no arbitrage condition @eq-binomialnoarbitrage in the previous section.  

A somewhat more enlightening description of the state prices is that $\pi_u$ is the price of an Arrow securtity that pays $1$ if the stock price goes up and nothing if the stock price goes down.  We can solve for portfolios of the stock and risk-free asset that have these payoffs.  Let $A$ be the number of shares of stock and $B$ be the amount borrowed or lent at time zero.  Then this portfolio will have a payoff of 1 in the up state and 0 in the down state if
$$A S_u + B e^{rt} = 1$$
and 
$$A S_d + B e^{rt} =0\,.$$

Solving these for $A$ and $B$, we get $A= \frac{1}{S_u - S_d}$ and $B = -e^{-rt}\frac{S_d}{S_u - S_d}$.  The time zero cost of this portfolio is $AS +B = \frac{S - e^{-rt} S_d}{S_u - S_d} = \pi_u$.  A similar exercise reveals $\pi_d$ is the time 0 price of a portfoio that has a value of 0 in the up state and 1 in the down state.  

Given the state prices, we can value any derivative security whose payoffs depend on the stock price and the risk free asset. For example, consider a European call option on the stock with maturity $t$ and strike $K$.   A call option gives the owner the right (but not the obligation) to buy the stock at the fixed price called the strike.  The value of this at the option maturity $t$ is the excess of the stock price over $K$ if the excess is positive and is zero otherwise, which we write as $C_u=\max(0,S_u-K)$ in the up state and $C_d=\max(0,S_d-K)$ in the down state. Therefore, the value of the call option today, $C$, is given by 
$$C = \pi_u C_u + \pi_d C_d\,.$$

#### Option Deltas and Replication 

A more traditional way to derive option prices is by finding a portfolio that replicates the option payoff.  By no arbitrage, the initial cost of the portfolio must be the option price.  We now show this is consistent with the state price approach.  Again consider a European call option on the stock with maturity $t$ and strike $K$.  

The delta of the call option is defined to be the difference between the call values in the up and down states divided by the difference between the underlying values; that is, $\delta = (C_u-C_d)/(S_u-S_d)$.  \index{delta} Multiplying by $S_u-S_d$ gives us $\delta(S_u-S_d) = C_u-C_d$ and rearranging yields  $\delta S_u - C_u = \delta S_d-C_d$, which is critical to what follows.  Consider purchasing $\delta$ shares of the stock at date $0$ and borrowing
$$\mathrm{e}^{-rt}(\delta S_u-C_u) = \mathrm{e}^{-rt}(\delta S_d-C_d)$$
dollars at date $0$.  Then you will owe 
$$\delta S_u-C_u = \delta S_d-C_d$$
dollars at date $t$, and hence the value of the portfolio at date $t$ in the up state will be
$$\text{value of delta shares} - \text{dollars owed} = \delta S_u - (\delta S_u-C_u) = C_u\; ,$$
and the value of the portfolio at date $t$ in the down state will be
$$\text{value of delta shares} - \text{dollars owed} = \delta S_d - (\delta S_d-C_d) = C_d\;\;.$$
Thus, this portfolio of buying delta shares and  borrowing money (i.e., buying delta shares on margin) *replicates* the call option.   Consequently, the value $C$ of the option at date $0$ must be the date--0 cost of the portfolio; i.e.,
$$
C = \text{cost of delta shares} - \text{dollars borrowed}$$
$$ = \delta S - \mathrm{e}^{-rt}(\delta S_u-C_u)\,.
$$ {#eq-C0}

::: Example
Suppose a stock price today is $S=100$, and suppose that the price at a future date $t$ will be either $S_u=110$ or $S_u=90$.  The following figure depicts this situation.



![](https://www.dropbox.com/scl/fi/2hcnid7odp83cmmdpbmwh/binomial_stock_oneperiod.jpg?rlkey=8pj7515da2cg0e2chwo6twu9c&dl=1)
{fig-align="center"}

Consider a call option with a strike of $K=105$ that matures at $t$.  The value of being able to buy a stock at $105$ and sell it for $110$ is $5$, and the value of being able to buy at $105$ and sell at $90$ is zero, so the value of the call option at date $t$ is as shown below.  Our goal is to answer the question: What is the call worth at date $0$?

![](https://www.dropbox.com/scl/fi/8bepe39y2ebipwezp4etw/binomial_call_oneperiod.jpg?rlkey=nfe9kb0asqk4bs83ye9ws4t59&dl=1){fig-align="center"}

We calculate the option $\delta$ as described above:
$$\frac{C_u - C_d}{S_u-S_d} = \frac{5-0}{110-90} = \frac{1}{4}\,.$$
The following shows the value of $\delta$ shares at date $0$ and at date $t$.

![](https://www.dropbox.com/scl/fi/f4kqqysjnt1hgfa4mylsg/binomial_deltashares_oneperiod.jpg?rlkey=fwjftso8kq44zz0b64m49oue1&dl=1){fig-align="center"}

The critical feature of this figure is that the difference between the up and down values at date $t$ is the same as the difference between the up and down values of the call; that is, it is $5$ dollars.  This is guaranteed by our formula for $\delta$.  The portfolio of $\delta$ shares is worth more than the call at date $t$, but if we owed $22.50$, then the value of the portfolio after paying back the loan would match the call value.  At an interest rate of 5% (as a rate from date $0$ to date $t$ instead of continuous compounding, for simplicity), we could borrow $21.43$ and then owe $22.50$.  This is depicted in the following.

![](https://www.dropbox.com/scl/fi/9pmf3yxeyuye6kl2tmumx/binomial_liability_oneperiod.jpg?rlkey=0exisdlr424nd5c8qk0e0dt3d&dl=1){fig-align="center"}

If we subtract the previous figure from the figure showing the value of $\delta$ shares, we obtain the figure below.  What it means is that if we invest $3.57$ of our own money, and borrow $21.43$, then we can buy $\delta$ shares, and, after paying back the loan with interest, our portfolio value will match the value of the call option.  In other words, we can *replicate* the call option by buying $\delta$ shares of the stock on margin.  Because we can create the call option value at date $t$ by investing $3.57$ of our own money at date $0$, the price of the call option at date $0$ should be $3.57$.  If the price of the call option were different, then there would be an arbitrage opportunity.  This is the calculation that is made in @eq-C0.

![](https://www.dropbox.com/scl/fi/9q8f2499idv7udmmfcon2/binomial_call_complete_oneperiod.jpg?rlkey=1guyoxpkfuq3y7dwuamg9zs02&dl=1){fig-align="center"}

:::

#### State Prices

We now rewrite the option pricing @eq-C0 in terms of state prices. \index{state price}
By substituting for $\delta$ in @eq-C0, we can rearrange @eq-C0 as


$$
C = \frac{S-\mathrm{e}^{-rt}S_d}{S_u-S_d} \times C_u + \frac{\mathrm{e}^{-rt}S_u-S}{S_u-S_d}\times C_d\; .
$$ {#eq-binomialC1}

A little algebra also shows that
$$
S = \frac{S-\mathrm{e}^{-rt}S_d}{S_u-S_d} \times 
S_u + \frac{\mathrm{e}^{-rt}S_u-S}{S_u-S_d}\times S_d\; ,
$$ {#eq-binomialS1}

and
$$
1 = \frac{S-\mathrm{e}^{-rt}S_d}{S_u-S_d} \times \mathrm{e}^{rt}+ \frac{\mathrm{e}^{-rt}S_u-S}{S_u-S_d}\times \mathrm{e}^{rt}\;.
$$ {#eq-binomialR1}


It is convenient to denote the factors appearing in these equations as
$$
\pi_u = \frac{S-\mathrm{e}^{-rt}S_d}{S_u-S_d} \quad \text{and} \quad \pi_d = \frac{\mathrm{e}^{-rt}S_u-S}{S_u-S_d}\;.
$$ {#eq-binomialstateprices}

The numbers $\pi_u$ and $\pi_d$ are called the state prices, for reasons that will be explained below.

With these definitions, we can write @eq-binomialC1--@eq-binomialR1 as

$$
C = \pi_uC_u + \pi_dC_d\;,
$$ {#eq-binomialC2}

$$
S = \pi_uS_u+\pi_dS_d\;,
$$ {#eq-binomialS2}

$$
1 = \pi_u\mathrm{e}^{rt} + \pi_d \mathrm{e}^{rt}\;.
$$ {#eq-binomialR2}


These equations have the following interpretation: the value of a security today is its value in the up state times $\pi_u$ plus its value in the down state times $\pi_d$.  This applies to @eq-binomialR2 by considering an investment of \$1 today in the risk-free asset---it has value 1 today and will have value $\mathrm{e}^{rt}$ in both the up and down states at date $t$.  Moreover, this same equation holds for any other derivative asset -- for example, a put option -- for the same $\pi_u$ and $\pi_d$ defined in @eq-binomialstateprices.  

We can think of any security as a portfolio of what are called Arrow securities (in recognition of the seminal work of Kenneth Arrow [@Arrow]).  \index{Arrow security} In this model, one of the Arrow securities pays \$1 at date $t$ if the up state occurs and the other pays \$1 at date $t$ if the down state occurs.  For example, the stock is equivalent to a portfolio consisting of $S_u$ units of the first Arrow security and $S_d$ units of the second, because the stock is worth $S_u$ dollars in the up state and $S_d$ dollars in the down state.   @eq-binomialC2--@eq-binomialR2 show that $\pi_u$ is the price of the first Arrow security and $\pi_d$ is the price of the second.  For example, the right-hand side of @eq-binomialS2 is the value of the stock at date $0$ viewed as a portfolio of Arrow securities when the Arrow securities have prices $\pi_u$ and $\pi_d$.  Because the stock clearly is such a portfolio, its price today must equal the value of that portfolio, which is what @eq-binomialS2 asserts.

As mentioned before, the prices $\pi_u$ and $\pi_d$ of the Arrow securities are called the state prices, because they are the prices of receiving \$1 in the two states of the world.  The state prices should be positive, because the payoff  of each Arrow security is nonnegative in both states and positive in one.  A little algebra shows that the conditions $\pi_u>0$ and $\pi_d>0$  are exactly equivalent to our no-arbitrage assumption @eq-binomialnoarbitrage.   

## Risk-Neutral Probability

We have our basic pricing formula
$$ P(X)= \sum_{s=1}^S \pi_s X_s $$
Let $p_s = \pi_s e^{rt}$.   Then $\sum_{s=1}^S p_s = 1$ and $p_s>0$.  Therefore, we can think of $p_s$ as probabilities.  We refer to $p_s$ as risk neutral probabilities.  Given this we can write
$$P(X)= \sum_{s=1}^S p_s e^{-rt} X_s $$
which can be thought of the expected discounted value of the future cash flows.  The risk neutral probabilities are so-called since we discount by the risk-free rate. However, the risk neutral probabilities should not be confused with actual probabilities since they are really prices.

Unlike the Capital Asset Pricing Model, for example, there is no risk premium in the discount rate.  This is the calculation we would do to price assets under the actual probabilities if investors were risk neutral (or for zero-beta assets).  So, we can act as if investors are risk neutral by adjusting the probabilities.^[This fundamental idea is due to Cox and Ross [@CR].]  Of course, we are not really assuming investors are risk neutral.  We have simply embedded any risk premia in the probabilities.

Notice the expected return using the risk neutral probabilities for any investement is the risk free rate:
$$\frac{\sum_{s=1}^S p_s X_s}{P(X)} = e^{rt}$$,
so it is important to realize that the risk neutral probabilities are distinct from the actual probabilities  used in portfolio theory.

#### Risk-Neutral Probability in the Binomial Model

To apply Key Principle \ref{principle:stateprices} in the most convenient way, we manipulate the state prices  so we can interpret the sums on the right-hand sides of  @eq-binomialC2--@eq-binomialR2 in terms of  expectations.  \index{expectation} The expectation (or mean) of a random variable is of course its probability-weighted average value.

Set $p_u = \pi_u\mathrm{e}^{rt}$ for the up state and $p_d = \pi_d\mathrm{e}^{rt}$ for the down state. @eq-binomialC2--@eq-binomialR2 can be written as

$$
C = \mathrm{e}^{-rt}[p_uC_u+p_dC_d]\;,
$$ {#eq-binomialC3}

$$
S = \mathrm{e}^{-rt}[p_uS_u+p_dS_d]\;,
$$ {#eq-binomialS3}

$$
1= p_u+p_d\;.
$$ {#eq-binomialR3}


The numbers $p_u$ and $p_d$ are called the risk-neutral probabilities of the up and down states.  The numbers are both positive (because the state prices are positive under our no-arbitrage assumption) and @eq-binomialR3 states that they sum to one, so it is indeed sensible to consider them as (artificial) probabilities.
 @eq-binomialC3 and @eq-binomialS3 state that the value of a security today is its expected value at date $t$ discounted at the risk-free rate, when we take the expectation using the risk-neutral probabilities.  Thus, these are present value formulas.  

 It follows from @eq-binomialS3 that the expected return of the stock under the risk-neutral probabilities is the risk-free return; that is,
 $$\frac{p_uS_u + p_dS_d}{S} = \mathrm{e}^{rt}\,.$$
 This is a general fact: expected returns relative to the risk-neutral probabilities equal the risk-free return.  

## Binomial Trees

In the binomial model, we assume that if the stock price is $S$ at the beginning of the period, it will be either $uS$ or $dS$ at the end of the period, where the multiplicative factors $u$ and $d$ are constants to be determined.  This means that the rate of return is $\Delta S/S = u\!-\!1$ in the up state and $\Delta S/S = d\!-\!1$ in the down state. There are three parameters to the model: $u$, $d$, and the probability $p$ of the up state (the probability of the down state being necessarily $1\!-\!p$). 


::: {#fig-binomial-trees}

<iframe width="720" height="800" src="https://binomial-trees.koyeb.app/"></iframe>

**Binomial trees for an underlying asset price and an option.** 
The interest rate should be the rate per period and should be adjusted based on the number of periods.  The **up move** parameter corresponds to the parameter $u$ in the text as $u=1+$ **up move."  The figure takes $d=1/u$.  Notice that the vertical axis is reverse ordered for put options, because higher stock prices produce lower put values.

:::

A tree constructed like this is recombining in the sense that the stock price after an up-down sequence is the same as after a down-up sequence.  This is very important for reducing the computation time.  For example, the number of nodes at the final date is $N+1$ in a recombining tree, where $N$ is the number of periods, but it is $2^N$ for a non-recombining (sometimes called bushy) tree.  Hence, the computation time will increase linearly with $N$ for a recombining tree but exponentially with $N$ for a non-recombining tree.  Unfortunately, this computational savings is generally not possible for path-dependent options, because the number of distinct paths through a tree (whether recombining or not) is again $2^N$.

 
The value of a European derivative is of course the discounted expectation of its value at maturity, discounting at the risk-free rate and taking the expectation under the risk-neutral probability.  The binomial tree allows us to approximate the expectation very easily.  We simply sum over the nodes of the tree at the option maturity and weight each node by its binomial probability.  In an $N$-period model, the probability of the top node is $p^N$, since the stock must go up each time to reach the top node.  There are $N$ paths reaching the second node from the top (since the period of the single down move could be any one of the $N$ periods) and each such path has probability $p^{N-1}(1-p)$; therefore, the probability of reaching the second node from the top is $Np^{N-1}(1-p)$.  More generally, the probability of going up $i$ times and down $N-i$ times is
$$\frac{N!}{i!(N-i)!}p^i(1-p)^{N-i}\; ,$$
where as usual $x!$ denotes $x$ factorial.  Therefore, the expectation, for a European call option,  is the following sum over the $N+1$ nodes at date $N$ (starting with $i=0$ up moves and ending with $i=N$ up moves):
$$
\sum_{i=0}^N \frac{N!}{i!(N-i)!}p^i(1-p)^{N-i}\max(u^id^{N-i}S-K,0)\;.
$$ {#eq-binomialsum}

Multiplying the expectation by $\mathrm{e}^{-rT}$ yields the option value.


## Exercises

::: {#exr-binomialcall}
 
 
Create a Python function in which the user inputs $S$, $S_d$, $S_u$, $K$, $r$ and $t$.  Check that the no-arbitrage condition @eq-binomialnoarbitrage is satisfied.  Compute the value of a call option in each of the following ways:

1. Compute the delta and use  @eq-C0.
2. Compute the state prices and use  @eq-binomialC2.
3. Compute the risk-neutral probabilities and use  @eq-binomialC3.
4. Compute the probabilities using the stock as numeraire and use  @eq-binomialC5.

Verify that all of these methods produce the same answer.
:::

::: {#exr-arbitrage2}
 
In a two-state model, a put option is equivalent to $\delta_p$ shares of the stock, where $\delta_p = (P_u-P_d)/(S_u-S_d)$ (this will be negative, meaning a short position) and some money invested in the risk-free asset.  Derive the amount of money $x$ that should be invested in the risk-free asset to replicate the put option.  The value of the put at date $0$ must  be $x+\delta_pS$.
:::

::: {#exr-arbitrage3}

Using the result of the previous exercise, repeat @exr-binomialcall} for a put option.
:::
