{
  "hash": "85d2233772469247b329251578a5a26f",
  "result": {
    "engine": "jupyter",
    "markdown": "\\newcommand{\\d}{\\,\\mathrm{d}}\n\\newcommand{\\e}{\\mathrm{e}}\n\\newcommand{\\E}{\\mathbb{E}}\n\n\n\n# Vasicek and Extensions {#sec-c:vasicek} \n\n::: {#baf3c55e .cell execution_count=1}\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<script type=\"text/javascript\" async src=\"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_SVG\"></script>\n```\n:::\n:::\n\n\n<!--\\chaptermark{The Extended Vasicek Model}-->\n\nIn the preceding chapter, we presented models for valuing swaptions, caps, and floors based on assumptions that certain forward rates have constant volatilities.  As noted, the assumptions used to value swaptions on the one hand and caps and floors on the other are inconsistent.  Because the values of fixed-income derivatives are derived from the yield curve, one can obtain a consistent model by developing a model of how the yield curve will evolve over time.  In this chapter, we will give a fairly full account of one popular and relatively simple model.  The next chapter contains much briefer descriptions of other models.\n\nWe will begin by describing the basic Vasicek model.  The extended Vasicek model (of which there are several versions) includes time-dependent parameters, so that it can be fit to the yield curve at the time it is used and possibly also to other market variables, such as cap prices or yield volatilities.  \n\n\n## The Short Rate and Discount Bond Prices {#sec-s:vasicek1}\n\nAn assumption of the Vasicek model and related models discussed in the next chapter is that there is an instantaneously risk-free rate.  Letting $r_s$ denote this rate at date $s$, the meaning of this assumption, as discussed in @sec-c:arbitrage, is that there is an asset with price process\n$$\nR_t = \\exp\\left(\\int_0^t r_s\\d   s\\right)\\;.\n$$\nThe instantaneous rate of return on this asset is\n$$\n\\frac{\\d  R_t}{R_t} = r_t\\d   t\\;.\n$$\n\nThere is no random term (of the form $\\sigma\\d   B$) in this rate of return; thus, we view the return as known at date $t$, whence the name instantaneously risk-free.  If there were another instantaneously risk-free asset with rate of return $\\hat{r}_t$ which differed from $r_t$ on a non-negligible set of dates and states of the world, there would be an arbitrage opportunity.  Hence, we will assume there is a unique instantaneously risk-free rate.  We will call this rate the short rate.  \\index{short rate}The interpretation of the price $R_t$ is that it is the amount that would be accumulated by date $t$, beginning with \\$1 at date $0$ and continuously rolling over the investment in the instantaneously risk-free asset.  It is conceptually similar to the net asset value of a money market fund, so $R$ is sometimes called the price of a money market account.  We will also call it an accumulation factor.\n\nThe probability measure associated with $R$ being the numeraire is called the \\index{risk-neutral probability}risk-neutral probability, just as when the short rate is constant.  Under the risk-neutral probability, the price $P(t,u)$ at date $t$ of a discount bond maturing at $u$ must be\n$$\nP(t,u) = R_t \\\\E^R_t \\left[\\frac{1}{R(u)}\\right] = \\\\E^R_t \\left[ \\exp\\left(-\\int_t^u r_s\\d   s\\right)\\right]\\;,\n$$ {#eq-basicbondprice}\n\nthe first equality being a result of our fundamental pricing @eq-formula and the fact that the discount bond pays \\$1 at maturity and the second equality following from the definition of $R$.  Thus, a model for the evolution of the short rate under the risk-neutral probability implies a model for discount bond prices and hence the yield curve.\n\n## The Vasicek Model {#sec-s:vasicek}\n\nIn the basic Vasicek [@Vasicek] model, \\index{Vasicek model}it is assumed that\n$$\n\\d  r_t = \\kappa\\big[\\theta-r_t\\big]\\d   t+\\sigma\\d   B_t\n$$ {#eq-vasicek}\n\nfor constants $\\kappa\\geq 0$, $\\theta$, and $\\sigma$, where $B$ is a Brownian motion under the risk-neutral probability.  In this model, $\\theta$ is the long-run mean of the short rate process and $\\kappa$ is interpreted as the rate of mean reversion.  \\index{mean reversion}When $r_t >\\theta$, the drift term will be negative and push $r$ down towards $\\theta$.  Likewise, when $r_t <\\theta$, the drift term will be positive and push $r$ up towards $\\theta$.  The rate at which $r$ drifts towards $\\theta$ is obviously determined by $\\kappa$.  **We are going to depart from our convention and call $\\sigma$ the volatility of the short rate** \\index{volatility}even though $\\sigma^2\\d   t$ is the instantaneous variance of $\\d  r$ rather than $\\d  r/r$.\n\nThe short rate is normally distributed in the Vasicek model.  Given information at date $t$---i.e., knowledge of $r_t$---then, if $\\kappa>0$,\n the rate $r_s$ for $s>t$ is normally distributed with mean^[These results on the mean and variance of $r_s$ follow from the solution @eq-vasicek_sol of the Vasicek @eq-vasicek.]\n$$\n\\theta + \\mathrm{e}^{-\\!\\kappa (s-t)}\\big[r_t-\\theta\\big]\n$$ {#eq-vasicekmean}\n\nand variance\n$$\n\\frac{\\sigma^2\\left(1-\\mathrm{e}^{-2\\kappa(s-t)}\\right)}{2\\kappa}\\;.\n$$ {#eq-vasicekvariance}\n\nFor any $r_t$, the mean converges to $\\theta$ at long horizons (i.e., as $s \\rightarrow \\infty$), justifying the interpretation of $\\theta$ as the long run mean.  In fact, the mean converges exponentially to $\\theta$ at rate $\\kappa$.  The variance at long horizons is $\\sigma^2/2\\kappa$.  On the other hand, if $\\kappa=0$, then the short rate is a Brownian motion with volatility $\\sigma$.  The mean of $r_s$ is $r_t$ for $s>t$, and the variance of $r_s$ is $(s-t)\\sigma^2$.  Thus, the uncertainty at long horizons, as measured by the variance, is unbounded when $\\kappa=0$.  Whether $\\kappa$ is positive or not, an implication of the normal distribution is that there is a positive probability of the short rate $r_s$ being negative at any date $s>t$, which should not be the case for (nominal) interest rates.  However, the probability of negative rates over any given horizon will be small if the variance is sufficiently small.  From @eq-vasicekvariance, we see that, when $\\kappa>0$, the variance will be small if either the volatility $\\sigma$ is small or the rate of mean reversion $\\kappa$ is large.\n\nThese facts about the distribution of the short rate demonstrate the importance of assuming mean reversion ($\\kappa>0$).  If $\\kappa=0$, the short rate (because it is a Brownian motion)  has the property that for any real number $K$, with probability one there will be some date $s>t$ such that $r_s>K$, irrespective of the starting position $r_t$.  Likewise, there will be some date $s'>t$ such that $r(s')<-K$.  Thus, the short rate wanders off in both directions in an unbounded way.  This property may be reasonable for the logarithm of a stock price, because a stock price may become arbitrarily high or arbitrarily close to zero (implying that the logarithm is unbounded both above and below).  However, it is not reasonable for an interest rate, which should exhibit more stability.  The assumption of mean reversion ($\\kappa>0$) provides this stability, guaranteeing that the uncertainty at long horizons is bounded and that on average the short rate will converge back to a finite long-run mean.  Nevertheless, we will give results in this chapter for the case $\\kappa=0$, because this is a particularly simple model and because it is the basic building block for what is called the continuous-time Ho-Lee model. \\index{continuous-time Ho-Lee model} The actual Ho-Lee model, \\index{Ho-Lee model}which is a binomial model, will be discussed in the following chapter.\n\n\nThe relative simplicity of the Vasicek model stems from the fact that under assumption @eq-vasicek the accumulation factor $R$ is lognormally distributed.  \\index{lognormal distribution}Specifically, at any date $t$ and given any date $u>t$, the random variable \n$$\n\\int_t^u r_s\\d   s\n$$\nis normally distributed.  Its mean and variance depend on the parameters $\\kappa$, $\\theta$, and $\\sigma$ and the length of the time interval $u-t$.  The mean also depends on the short rate $r_t$ at date $t$.  Therefore, the discount bond price depends on the same things.  \n\nWe will now present an explicit formula for discount bond prices, based on the fundamental @eq-basicbondprice.\nBy taking the Ito differential of $r_s$ in the following, one can verify that it is the solution of the Vasicek model @eq-vasicek:^[@eq-vasicek_sol implies the distributional properties of $r_s$ stated earlier.\nThe integral $\\int_t^s \\mathrm{e}^{-\\!\\kappa (s-y)} \\d   B(y)$ is normally distributed with mean zero; therefore equation~@eq-vasicek_sol shows that the mean of $r_s$ in the case $\\kappa>0$ is as given in @eq-vasicekmean.  The variance is computed, following the rules in @sec-c:continuoustime, as $\\int_t^s \\mathrm{e}^{-2\\kappa (s-y)}\\d   y$, which simplifies to the formula given in @eq-vasicekvariance.}\n$$\nr_s =  \\theta - \\mathrm{e}^{-\\!\\kappa (s-t)}\\big[\\theta-r_t\\big]+ \\sigma \n\\int_t^s \\mathrm{e}^{-\\!\\kappa (s-y)} \\d   B(y).\n$$ {#eq-vasicek_sol}\n\nIf $\\kappa=0$, this simplifies to\n$$\nr_s = r_t + \\sigma\\int_t^s\\d  B(y)= r_t + \\sigma[B_s-B_t]\\;. \n$$ {#eq-vasicek_sol2}\n\nThese equations imply the following.\n\n::: Rule\n## \n\nIn the Vasicek model, consider dates $t<u$ and define $\\tau=u-t$.  Given the short rate $r_t$ at date $t$,\nthe discount bond price has the form\n\n$$\nP(t,u) = \\exp\\left(-a(\\tau)-b(\\tau)r_t\\right)\\;, \n$$ {#eq-vasicekbond}\n\nwhere, if $\\kappa=0$,\n\n$$\na(\\tau)=-\\sigma^2\\tau^3/6\\;,\n$$ {#eq-vasicek_ak0}\n\n$$\nb(\\tau) = \\tau\\;,\n$$ {#eq-vasicek_bk0}\n\nand, if $\\kappa>0$,\n$$\na(\\tau)= \\theta\\tau-\\frac{\\theta}{\\kappa}\\left(1-\\mathrm{e}^{-\\kappa\\tau}\\right)-\\frac{\\sigma^2}{4\\kappa^3}\\left(2\\kappa\\tau -\\mathrm{e}^{-2\\kappa\\tau}+4\\mathrm{e}^{-\\kappa\\tau}-3\\right)\\;,\n$$ {#eq-vasicek_a1111}\n\n$$\nb(\\tau)= \\frac{1}{\\kappa}\\left(1-\\mathrm{e}^{-\\kappa\\tau}\\right)\\;.\n$$ {#eq-vasicekb1111}\n\n\n\n\n:::\n\n\n::: Extra\n ## \n\nWe will end this section with a proof of @eq-vasicekbond - @eq-vasicekb1111 in the case $\\kappa=0$.  The formula for $\\kappa>0$ can be established by the same reasoning, the calculations being only slightly more complicated.\nFrom  @eq-vasicek_sol2, we have\n\\begin{align*}\n\\int_t^u r_s\\d   s & = \\int_t^u \\left[r_t+\\sigma \\int_t^s \\d  B(y)\\right]\\d   s\\\\\n&=\\tau\\, r_t+\\sigma \\int_t^u \\left\\{\\int_t^s \\d  B(y) \\right\\} \\d   s\\; .\n\\end{align*}\nWe can change the order of integration in the double integral above to obtain\n\\begin{align*}\n\\int_t^u \\left\\{\\int_t^s \\d  B(y) \\right\\} \\d   s &=\\int_t^u \\left\\{\\int_y^u \\d  s\\,\\right\\} \\d  B(y)\\\\\n&=\\int_t^u (u-y)\\d   B(y)\\;.\n\\end{align*}\nGiven the information at date $t$, this is a normally distributed random variable with mean zero and variance equal to\n$$\n\\int_t^u (u-y)^2\\d   y = \\frac{\\tau^3}{3}\\;.\n$$\nTherefore, \n$\\int_t^u r_s\\d   s$\nis normally distributed with mean  $\\tau\\, r_t$ and variance $\\sigma^2\\tau^3/3$.  We now use the fact that if $x$ is normally distributed with mean $\\mu$ and variance $\\sigma^2$, then the mean of $\\mathrm{e}^x$ is $\\mathrm{e}^{\\mu+\\sigma/2}$.  Substituting this into  @eq-basicbondprice gives the result.\n:::\n\n\n## Estimating the Vasicek Model\n\nOne way to choose the parameters $\\kappa$, $\\theta$ and $\\sigma$ of the Vasicek model is to imply them from market bond prices and @eq-vasicekbond - @eq-vasicekb1111.  This is analogous to implying the volatility of a stock from market option prices and the Black-Scholes formula.  This can also be viewed as an alternative to fitting a cubic spline, as discussed in @sec-c:fixedincomeconcepts.  Rather than selecting the parameters of the cubic spline to provide the best approximation to market bond prices, one can choose the Vasicek parameters $\\kappa$, $\\theta$ and $\\sigma$.  The @eq-basicbondprice will then give prices of discount bonds of all maturities.^[Of course, the fit to market bond prices will typically be poorer with fewer parameters; therefore, the Vasicek yield curve will typically not fit as well as a cubic spline.]\n\nAn alternative procedure is to estimate the parameters from historical data on the short rate.  The short rate \\index{short rate}is a theoretical construct and one must choose some proxy to use for empirical work, for example, the Federal Funds rate, or the yield of a short-term (typically one-month or three-month) Treasury bill.  One also needs to use a proxy for the short rate when implying the parameters from market bond prices as described in the previous paragraph (or one could view the short rate as one of the parameters to be implied).\n\nAn issue that arises when estimating the model from historical data is that the Vasicek @eq-vasicek characterizes the evolution of the short rate relative to a Brownian motion under the risk-neutral probability, whereas the historical data is governed by the actual measure.  Vasicek [@Vasicek] actually assumed that  @eq-vasicek holds relative to a Brownian motion under the actual probability measure.  We will write his assumption as\n$$\n\\d  r_t = \\kappa^*[\\theta^*-r_t]\\d   t + \\sigma^*\\d   B^*_t\\;,\n$$ {#eq-vasicekactual}\n\nwhere $\\kappa^*$, $\\theta^*$, $\\sigma^*$ are constants and $B^*$ is a Brownian motion under the actual probability measure.^[Note that our notation is the reverse of what many people use: here $B$ denotes a Brownian motion under the risk-neutral probability (under which we will primarily operate) and $B^*$ denotes a Brownian motion under the actual measure.]  Vasicek then assumed a constant market price of risk $\\lambda$ \\index{market price of risk}and deduced that^[The price of risk is the new drift of $B^*$ when we change from the actual measure to the risk-neutral probability.  See Appendix~\\ref{a_girsanov].}\n$$\n\\d  r_t = \\kappa^*[\\theta^*-r_t]\\d   t + \\sigma^*\\lambda\\d   t + \\sigma^*\\d   B_t\\;, \n$$ {#eq-vasicekpriceofrisk}\n\nwhere $B$ is a Brownian motion under the risk-neutral probability.  This is the same as  @eq-vasicek when we define $\\kappa=\\kappa^*$, $\\sigma=\\sigma^*$, and $\\theta = \\theta^*+\\sigma^*\\lambda/\\kappa^*$.  This means that the mean-reversion and volatility parameters are the same under the actual and risk-neutral probabilitys, whereas the long-run mean parameters $\\theta$ and $\\theta^*$ are related via the market price of risk.  Thus, to estimate  $\\kappa$, $\\theta$ and $\\sigma$ in  @eq-vasicek, we could estimate $\\kappa^*=\\kappa$, $\\sigma^*=\\sigma$, and $\\theta^*$ from  @eq-vasicekactual and historical data and then choose  $\\theta$ to best fit market bond prices.\n\nWe can estimate the parameters of  @eq-vasicekactual by linear regression. Suppose we have data on a proxy for the short rate at dates $t_0, t_1, \\ldots, t_N$, with $t_{i}-t_{i-1}=\\Delta t$ for each $i$. The solution @eq-vasicek_sol of the Vasicek @eq-vasicek for the short rate, adapted to @eq-vasicekactual, implies the following equation for the changes in the short rate:\n\\begin{multline*}\nr_{t_i} - r_{t_{i-1}} = \\left(1- \\mathrm{e}^{-\\!\\kappa^* \\Delta t}\\right)\\theta^* -\\left(1- \\mathrm{e}^{-\\!\\kappa^* \\Delta t}\\right)r_{t_{i-1}} \\\\+ \\sigma^* \n\\int_{t_{i-1}}^{t_i} \\mathrm{e}^{-\\!\\kappa^* (t_i-a)} \\d   B^*(a)\\; .\n\\end{multline*}\nWe can write this as\n$$\nr_{t_i} - r_{t_{i-1}} = a + b\\,r_{t_{i-1}} + \\varepsilon\n$$\nwhere $\\varepsilon$ is a normally distributed random variable, independent of $r_{t_{i-1}}$, with mean zero and variance\n$$\n\\sigma^{*2} \n\\int_{t_{i-1}}^{t_i} \\mathrm{e}^{-2\\kappa^* (t_i-a)}\\d   a = \\frac{\\sigma^{*2}\\left(1-\\mathrm{e}^{-2\\kappa^*\\Delta t}\\right)}{2\\kappa^*}\\;.\n$$\nWe can estimate $a$, $b$ and the variance of $\\varepsilon$ by linear regression and then obtain $\\kappa^*$, $\\theta^*$ and $\\sigma^*$ from the equations\n\\begin{align*}\na& = \\left(1- \\mathrm{e}^{-\\!\\kappa^* \\Delta t}\\right)\\theta^*\\; ,\\\\\nb&= -\\left(1- \\mathrm{e}^{-\\!\\kappa^* \\Delta t}\\right)\\; ,\\\\\n\\text{var}(\\varepsilon) &= \\frac{\\sigma^{*2}\\left(1-\\mathrm{e}^{-2\\kappa^*\\Delta t}\\right)}{2\\kappa^*}\\;.\n\\end{align*}\n\n## Hedging in the Vasicek Model {#sec-s:vasicekhedging}\n\n\nBecause the Brownian motion driving the short rate also drives all the discount bond prices, the bond prices are (instantaneously) perfectly correlated in the Vasicek model (and also in the extensions we will consider next).  This is true in any model in which there is a single factor, such as the short rate, that determines all bond prices.  The volatilities of the bond returns determine the hedge ratios for hedging one bond with another.  \n\n@eq-vasicekbond and Ito's formula (the rule that, if $P=\\mathrm{e}^X$, then $\\d  P/P = dX + (dX)^2/2$) imply that for any date $t$ and any fixed maturity date $u>t$, we have\n$$\n\\frac{\\d  P(t,u)}{P(t,u)} = r_t\\d   t - \\sigma b(u\\!-\\!t)\\d   B_t\\;.\n$$ {#eq-vasicekbondreturn}\n\nBecause $B$ is a Brownian motion under the risk-neutral probability, this equation implies that the expected rate of return on a discount bond under the risk-neutral probability is the short rate.  This is not a surprise, because it is true for every asset under the risk-neutral probability.  What is important in this equation is that the volatility is a non-random function of the date $t$, given the maturity $u$.\n\nAs an example, consider hedging a short two-year bond with a long position in a one-year bond at some date $t$.  \nAccording to @eq-vasicekbondreturn, the change in the value of the short position in the two-year bond  will be\n$$\n-P(t,t+2)r_t\\d   t-P(t,t+2)\\sigma b(2)\\d   B_t\n$$\n\nSuppose we hold $x$ units of the one-year bond as a hedge and borrow \n$$\nxP(t,t+1)-P(t,t+2)\n$$\n\ndollars at the instantaneously risk-free rate to finance the hedge.  Then the change in the value of the portfolio will be\n\\begin{multline*}\nxP(t,t+1)r_t\\d   t+xP(t,t+1)\\sigma b(1)\\d   B_t \\\\- P(t,t+2)r_t\\d   t-P(t,t+2)\\sigma b(2)\\d   B_t \\\\- [xP(t,t+1)-P(t,t+2)]\\,r\\d  t \\\\= xP(t,t+1)\\sigma b(1) \\d   B_t -P(t,t+2)\\sigma b(2)\\d   B_t\\;,\n\\end{multline*}\nso a perfect hedge is obtained by setting\n$$\nx = \\frac{b(2)P(t,t+2)}{b(1)P(t,t+1)}\\;.\n$$\nIn the case $\\kappa=0$, this simplifies to $x=2P(t,t+2)/P(t,t+1)$, which means that the dollar value $xP(t,t+1)$ of the holding in the one-year bond is \n  twice the dollar value of the short position in the two-year bond.  One holds twice as much of the one-year bond, because it is half as volatile as the two-year bond in this model.\n\nBy this same reasoning, one can compute a perfect hedge for any discount bond by using another discount bond of any maturity.  In fact, one can hedge any term structure derivative in this model by investing the right amount in a bond of any maturity.  This is clearly overly simplistic, and such arbitrary hedges would not be used in practice.\n\nThere is a close connection between hedging in this model and duration hedging, \\index{duration hedging}as discussed in @sec-s:duration.  To see this, consider a coupon\nbond that at date $t$ has remaining cash flows $C_1, \\ldots, C_n$ at dates $t+\\tau_1 < \\cdots < t+\\tau_n$ and price $P_t$.  Its price should satisfy\n$$\nP_t = \\sum_{j=1}^n C_jP(t,t+\\tau_j)\\;.\n$$\nIn the Vasicek model, the random part of the change in the price of the coupon bond is\n$$\n-\\sigma\\left(\\sum_{j=1}^n b(\\tau_j)C_jP(t,t+\\tau_j)\\right)\\d   B_t \\; ,\n$$\nand the random part of the return is\n$$\n-\\sigma\\left(\\sum_{j=1}^n \\frac{b(\\tau_j)C_jP(t,t+\\tau_j)}{P_t}\\right)\\d   B_t\\;.\n$$ {#eq-vasicekcouponreturn}\n\n\nConsider the case $\\kappa=0$.  Then $b(\\tau_j)=\\tau_j$, so the random part of the return of the coupon bond  is\n$$\n-\\sigma\\left(\\sum_{j=1}^n \\frac{\\tau_jC_jP(t,t+\\tau_j)}{P_t}\\right)\\d   B_t\\;.\n$$\nThe factor in parentheses is Duration$'$ defined in @eq-newduration100.  Denoting it now as $D_t$ and recognizing that the expected rate of return of the bond must be the short rate, we have, in the Vasicek model with $\\kappa=0$,\n$$\n\\frac{\\d  P_t}{P_t} = r_t\\d   t - \\sigma D_t\\d   B_t\\;.\n$$\nIt follows that in this model one can hedge any fixed-income liability by holding enough of any coupon bond such that the dollar value multiplied by its  duration equals  the dollar value of the liability multiplied by its  duration.  In @sec-s:duration, we noted that duration matching works for parallel shifts in the yield curve.  \\index{yield curve!parallel shift}Later, we will see that in the Vasicek model with $\\kappa=0$ only parallel shifts in the yield curve are possible.  Therefore, it should not be surprising that duration matching works in this model.\n\nIn the case $\\kappa>0$, one can interpret the volatility of the coupon bond similarly.  The analogue to duration for this model is the weighted average of the function $b(\\tau_j)$ of the times to maturity, as @eq-vasicekcouponreturn shows.  The weights again are the fractions of the bond value that each cash flow contributes.\n\n\n\n## Extensions of the Vasicek Model\n\nTo fit the model to current market conditions at the time the model is being used, the parameters $\\kappa$, $\\theta$ and $\\sigma$ can be taken to be time-dependent.  The model with time-dependent parameters is studied in Hull and White [@HW] and is usually called the Hull-White model.  \\index{Hull-White model}It is convenient to denote by $\\theta_t$ the time-dependent function replacing the constant $\\kappa\\theta$ in the definition of the Vasicek model @eq-vasicek; that is, we redefine as $\\theta$ what was previously $\\kappa\\theta$.^[Some authors (including Hull and White) do not make this definition---i.e., they denote by $\\kappa_t\\theta_t$ what we are denoting by $\\theta_t$---so be careful when combining results from different sources.]   As usual, we will let date $0$ be the date at which we are using the model.  The model is then, for $t>0$, \n$$\n\\d  r_t = \\theta_t\\d   t - \\kappa_tr_t\\d   t + \\sigma_t\\d   B_t\\;.\n$$ {#eq-hw500}\n\n\nWe will focus on the simplest case, in which $\\kappa$ and $\\sigma$ are constants, deferring discussion of the general case to the last section of this chapter.  The general case is quite similar, with the formulas being only slightly more complicated.\nSo, we assume now that\n$$\n\\d  r_t = \\theta_t\\d   t - \\kappa r_t\\d   t + \\sigma \\d   B_t\\;. \n$$ {#eq-hw5000}\n\nfor a non-random function $\\theta$.  \nWe will call this model with $\\kappa>0$ the Hull-White model.  The model with \n $\\kappa=0$ (i.e., in the absence of mean reversion) is called the continuous-time Ho-Lee model.  We will refer to the general case @eq-hw500 as the general Hull-White model, and we will discuss it in @sec-s:generalHW.\n  In the Hull-White model, we can interpret $\\theta_t/\\kappa$ as a time-varying long-run mean of the short rate process, because we have\n$$\\d  r_t = \\kappa\\left[ \\frac{\\theta_t}{\\kappa} - r_t\\right]\\d   t + \\sigma\\d   B_t\\; .$$\n\\vfil\\eject\nOne can show by the following by directly differentiating.\n\n::: Rule\n## \n\nIn the Hull-White model,\n\n$$\nr_s = \\phi_s + \\hat{r}_s\\;,\n$$ {#eq-vasicekextension_sol}\n\nwhere \n\n$$ \n\\phi_s =  \\int_0^s\\mathrm{e}^{-\\kappa(s-y)}\\theta(y)\\d   y\\;,\n$$ {#eq-phi102}\n\nand\n$$\n\\hat{r}_s = \\mathrm{e}^{-\\kappa s}r_0+\\sigma\\int_0^s\\mathrm{e}^{-\\kappa(s-y)}\\d   B(y)\\;.\n$$ {#eq-rhat102}\n\nWhen $\\kappa=0$ (the continuous-time Ho-Lee model), these formulas simplify to\n$$\n\\phi_s =  \\int_0^s\\theta(y)\\d   y\\;. \n$$ {#eq-phi103}\n\nand\n$$\n\\hat{r}_s = r_0+\\sigma B_s\\;. \n$$ {#eq-rhat103}\n\n\n\n:::\n\nNote that @eq-rhat102 and @eq-rhat103 imply\n$$\n\\d \\hat{r}_t = -\\kappa \\hat{r}_t\\d   t + \\sigma\\d   B_t\\; ,\n$$ {#eq-rhat10001}\n\nwhere $\\kappa=0$ for @eq-rhat103.  Thus, $\\hat{r}$ is a Vasicek short-rate process having a long-run mean of zero.\n\nThe virtue of the expression for $r$ given in @eq-vasicekextension_sol - @eq-rhat103 is that the basic bond pricing @eq-basicbondprice now gives us\n\n$$\nP(t,u) = \\\\E^R_t \\left[ \\exp\\left(-\\int_t^u r_s\\d   s\\right)\\right]\n$$\n$$\n= \\\\E^R_t \\left[ \\exp\\left(-\\int_t^u \\phi_s + \\hat{r}_s\\d   s\\right)\\right]\n$$\n$$\n= \\\\E^R_t \\left[ \\exp\\left(-\\int_t^u \\phi_s\\d   s\\right)\\exp\\left(-\\int_t^u  \\hat{r}_s\\d   s\\right)\\right]\n$$\n$$\n= \\exp\\left(-\\int_t^u \\phi_s\\d   s\\right)\\\\E^R_t \\left[ \\exp\\left(-\\int_t^u \\hat{r}_s\\d   s\\right)\\right]\\;.\n$$ {#eq-vasicekpullsout}\n\n\nThus, the non-random part $\\phi_s$ of the short-rate process pulls out of the expectation in the pricing formula.  Furthermore, we have already calculated the expectation in @eq-vasicekpullsout because it is the discount bond price in the Vasicek model with a long-run mean of zero.  This yields the following.\n\n\n::: Rule\n## \nConsider dates $t<u$ and define $\\tau=u-t$.  The price at date $t$ of a discount bond maturing at date $u$ in the extended Vasicek model is\n\n$$\nP(t,u) = \\exp\\left(-\\int_t^u \\phi_s\\d   s-a(\\tau)-b(\\tau)\\hat{r}_t\\right)\\;,\n$$ {#eq-extendedvasicekbond}\n\nwhere, in the continuous-time Ho-Lee model,\n\n$$\na(\\tau)=-\\sigma^2\\tau^3/6\\;,\n$$ {#eq-extendedvasicekbond_ak0}\n\n$$\nb(\\tau) = \\tau\\;,\n$$ {#eq-extendedvasicekbond_bk0}\n\nand, in the Hull-White model,\n$$\na(\\tau)= -\\frac{\\sigma^2}{4\\kappa^3}\\left(2\\kappa\\tau -\\mathrm{e}^{-2\\kappa\\tau}+4\\mathrm{e}^{-\\kappa\\tau}-3\\right)\\;,\n$$ {#eq-extendedvasicek_a}\n\n$$\nb(\\tau)= \\frac{1}{\\kappa}\\left(1-\\mathrm{e}^{-\\kappa\\tau}\\right)\\;.\n$$ {#eq-extendedvasicek_b}\n\n\n\n\n:::\n\n\n\nUsing the fact that the expected rate of return on a discount bond must be the short rate under the risk-neutral probability, we obtain from  @eq-extendedvasicekbond and  @eq-rhat10001 that, for each fixed maturity date $u$,\n$$\n\\frac{\\d  P(t,u)}{P(t,u)} = r_t\\d   t - \\sigma b(\\tau)\\d   B_t\\;.\n$$ {#eq-extendedvasicekbondreturn}\n\nThus, the volatilities are determined by the function $b$, just as in the basic Vasicek model.  The computation of hedge ratios is therefore analogous to the computations presented in @sec-s:vasicekhedging for the basic Vasicek model.  In fact, the volatilities of discount bond returns in the  Hull-White model are the same as in the Vasicek model with $\\kappa>0$, and the volatilities in the continuous-time Ho-Lee model are the same as in the Vasicek model with $\\kappa=0$.  \n\n\n\n\n\n## Fitting Discount Bond Prices and Forward Rates {#sec-s:vasicek_fitting}\n\nIt is simple to fit the Hull-White model and continuous-time Ho-Lee model to market discount bond prices  by choosing the function $\\phi$.  We will use the superscript mkt to denote market prices.  Letting date $0$ denote the date at which we are fitting the model, we want to have\n$$\nP^{\\text{mkt}}(0,u) = P(0,u)\n$$\nfor all maturities $u$, where $P(0,u)$ denotes the model prices given in  @eq-extendedvasicekbond as\n$$\nP(0,u) = \\exp\\left(-\\int_0^u \\phi_s\\d   s-a(u)-b(u)r_0\\right)\\;.\n$$\nThe functions $a$ and $b$ depend on $\\kappa$ and $\\sigma$, but we regard them now as having already been chosen.  Therefore, to match the model prices to market prices, we simply have to set\n$$\n\\exp\\left(-\\int_0^u \\phi_s\\right) = \\exp\\left(a(u)+b(u)r_0\\right)P^{\\text{mkt}}(0,u)\\;.\n$$ {#eq-vasicekcalibration101}\n\n\nUsually  we will only need to solve  @eq-vasicekcalibration101 for a finite number of maturities $u$ in order to calibrate the model sufficiently.  We will illustrate this in the analysis of coupon bond options in @sec-s:vasicek_swaptions.  However, the equation can be solved in principle for each maturity $u$ as follows:  take the natural logarithm of both sides, multiply by minus 1, and differentiate with respect to $u$ to obtain\n$$\n\\phi(u) = -\\frac{\\partial a(u)}{\\partial u} - \\frac{\\partial b(u)}{\\partial u}r_0 - \\frac{ \\partial \\log P^{\\text{mkt}}(0,u)}{\\partial u}\\;.\n$$ {#eq-extendedvasicekforwards1}\n\n\n\n@eq-extendedvasicekforwards1 gives the solution of the model for $\\phi(u)$, and it also has an important interpretation.  We can obviously rearrange it as\n$$\n\\phi(u) +\\frac{\\partial a(u)}{\\partial u} + \\frac{\\partial b(u)}{\\partial u}r_0 = -\\frac{ \\partial \\log P^{\\text{mkt}}(0,u)}{\\partial u}\\;. \n$$ {#eq-extendedvasicekforwards}\n\nThe expression \n$$\n-\\frac{\\partial \\log P^{\\text{mkt}}(0,u)}{\\partial u}\n$$\nis the *market* instantaneous forward rate \\index{forward rate!instantaneous}at date $0$ for maturity $u$.  The left-hand side of  @eq-extendedvasicekforwards is equal to\n$$\n-\\frac{\\partial \\log P(0,u)}{\\partial u}\\; ,\n$$\nand hence is the *model* instantaneous forward rate at date $0$ for maturity $u$.  \nTherefore, fitting the model to the yield curve is equivalent to fitting model forward rates to market forward rates.^[To understand the interpretation of the derivatives of the log bond prices as forward rates, consider the market prices $P^{\\text{mkt}}(0,u)$.   Recall from our discussion in @sec-s:forwardrates that to lock in at date $0$ the rate of interest on a \\$1 loan from dates $u$ to $u'$, one can buy a unit of the discount bond maturing at $u$ and raise the funds $P^{\\text{mkt}}(0,u)$ required by short-selling $P^{\\text{mkt}}(0,u)/P^{\\text{mkt}}(0,u')$ units of the bond maturing at $u'$, which leads to an obligation of $P^{\\text{mkt}}(0,u)/P^{\\text{mkt}}(0,u')$ dollars at date $u'$.  The continuously compounded forward rate for the loan between dates $u$ and $u'$ is therefore $x$ defined by\n$$\n\\mathrm{e}^{(u'-u)x} = \\frac{P^{\\text{mkt}}(0,u)}{P^{\\text{mkt}}(0,u')}\\;.\n$$\nEquivalently,\n$$\nx = \\frac{\\log P^{\\text{mkt}}(0,u) -\\log P^{\\text{mkt}}(0,u')}{u'-u} = - \\frac{\\log P^{\\text{mkt}}(0,u') -\\log P^{\\text{mkt}}(0,u)}{u'-u}\\;.\n$$\nAs we make the maturity of the loan shorter, with $u' \\rightarrow u$, the limit of the above (the forward rate for an instantaneous loan) is by definition the derivative (the usual calculus derivative) of $-\\log P^{\\text{mkt}}(0,u)$.}\n\nIt is very important to note that if we choose the function $\\phi_t$ at date $0$ to match the market, then when we want to recalibrate the model at some later date to match the market at that date, we will have to select a different $\\phi$ function at the later date.  In other words, we use a model today that we know we will discard as incorrect tomorrow.  The $\\phi$ function (as well as the $\\kappa$ and $\\sigma$ functions in the general Hull-White model) is continually discarded and refit to match the market.  This is an unpleasant reality, but it is not really too different from using implied volatilities in the Black-Scholes formula.  We know that the implied volatility curve changes over time, so the volatility we use tomorrow may well be different from the volatility we use today.  No model is every a literally correct description of the real world.  As has been said, the test of the pudding is in the tasting.  The test of a model is whether it generates reasonably correct values and hedges.  This is an empirical question, and it is not equivalent to the question of whether the assumptions of the model are correct.\n\n## Discount Bond Options, Caps and Floors {#sec-s:vasicek_discounts}\n\nWe can use Black's formula to value discount bond options \\index{discount bond option} in the Vasicek model and in its extensions.  As explained in the previous chapter, caps and floors are portfolios of discount bond options, so the values of caps (floors) can be computed by summing the  values of the individual caplets (floorlets).\nThe reason we can apply Black's formula is that the volatility of the forward price of a discount bond is non-random in the Vasicek model and its extensions.  \n\nConsider valuing at date $0$ an option maturing at date $T$ on a discount bond maturing at $u>T$.  Because forward must equal spot at maturity, an option written on a forward contract maturing at $T$ is equivalent.^[This is the same reasoning we used to derive Merton's formulas from Black's formulas in @sec-s:merton]. The forward price of the discount bond at date $t \\leq T$ for a forward contract maturing at $T$ is given by\n$$\nF_t =\\frac{P(t,u)}{P(t,T)}\\;.\n$$\nFrom Ito's formula and the equation~@eq-extendedvasicekbondreturn for the discount bond returns, we have\n\\begin{align*}\n\\frac{\\d  F_t}{F_t} &= \\text{something}\\d   t + \\frac{\\d  P(t,u)}{P(t,u)} - \\frac{\\d  P(t,T)}{P(t,T)}\\\\\n&= \\text{something}\\d   t -\\sigma[b(u-t)-b(T-t)]\\d   B_t\\;.\n\\end{align*}\nThus, the volatility depends on the non-random function $b$.\n\nIn the continuous-time Ho-Lee model, we have\n$$\nb(u-t)-b(T-t) = u-T\\;.\n$$\nTherefore, the forward price has a constant volatility equal to $(u-T)\\sigma$.  In the Hull-White model, we have\n$$\nb(u-t)-b(T-t) = \\frac{1}{\\kappa}\\left(\\mathrm{e}^{-\\kappa(T-t)}-\\mathrm{e}^{-\\kappa(u-t)}\\right) = \\frac{\\left(\\mathrm{e}^{-\\kappa T} - \\mathrm{e}^{-\\kappa u}\\right)\\mathrm{e}^{\\kappa t}}{\\kappa} \\;.\n$$\nThus, the volatility is time varying (it depends on $t$), so we compute the average \nvolatility as in @sec-s:timevaryingvolatility and @sec-s:volatility.  Specifically,\n\n$$\n\\sigma_{\\text{avg}} = \\frac{\\sigma\\left(\\mathrm{e}^{-\\kappa T} - \\mathrm{e}^{-\\kappa u}\\right)}{\\kappa} \\sqrt{\\frac{1}{T}\\int_0^T \\mathrm{e}^{2\\kappa t}\\d   t}\n$$\n$$\n=\\frac{\\sigma\\left(\\mathrm{e}^{-\\kappa T} - \\mathrm{e}^{-\\kappa u}\\right)}{\\kappa}\\sqrt{\\frac{\\mathrm{e}^{2\\kappa T}-1}{2\\kappa T}}\\;.\n$$ {#eq-vasiceksigmaavg}\n\n\n\nSubstituting $P^{\\text{mkt}}(0,u)/P^{\\text{mkt}}(0,T)$ as the forward price of the discount bond maturing at $u$ in Black's formula gives the following.\n\n\n::: Rule\n## \nConsider an option with exercise price $K$ maturing at date $T$ on a discount bond maturing at date $u>T$.  In the extended Vasicek model, the values at date $0$ of such options are\n\n\n$$\n\\text{Call Price} =P^{\\text{mkt}}(0,u)\\mathrm{N}(d_1) - P^{\\text{mkt}}(0,T)K\\mathrm{N}(d_2)\\;,\n$$ {#eq-vasicekdiscountcall}\n\n$$\n\\text{Put Price} = P^{\\text{mkt}}(0,T)K\\mathrm{N}(-d_2)-P^{\\text{mkt}}(0,u)\\mathrm{N}(-d_1)\\;,\n$$ {#eq-vasicekdiscountput}\n\n\nwhere\n\n$$\nd_1 = \\frac{\\log P^{\\text{mkt}}(0,u) - \\log\\left(P^{\\text{mkt}}(0,T)K\\right) +\\frac{1}{2}\\sigma_{\\text{avg}}^2T}{\n\\sigma_{\\text{avg}}\\sqrt{T}}\\;,\n$$ {#eq-vasicekdiscountcall_d1}\n\n$$\nd_2 = d_1 - \\sigma_{\\text{avg}}\\sqrt{T}\\;. \n$$ {#eq-vasicekdiscountcall_d2}\n\n\n\nThe volatility $\\sigma_{\\text{avg}}$ is defined as $\\sigma_{\\text{avg}} = (u-T)\\sigma$ in the continuous-time Ho-Lee model and according to @eq-vasiceksigmaavg in the Hull-White model.\n\n:::\n\n\\noindent As our notation indicates, the discount bond prices  appearing in these formulas  should be taken to be the market prices of the bonds at the date the options are valued, rather than the model prices.  Of course, if we have fit the model to the market prices of discount bonds, there is no distinction.    Using model prices that are different from market prices would be similar to inputting a stock price in the Black-Scholes formula obtained from a discounted-cash-flow analysis rather than using the market price of the stock.  This is not something that one would normally do.  \n\nBecause the discount bond volatilities are the same in the continuous-time Ho-Lee model as in the basic Vasicek model with $\\kappa=0$ and are the same in the Hull-White model as in the basic Vasicek model with $\\kappa>0$, the formulas for the values of discount bond options are the same in the corresponding models.  These extensions of the basic Vasicek model permit one to match model bond prices to market bond prices, but they have no effect on the values of discount bond options, provided we remember to use the market prices in  @eq-vasicekdiscountcall - @eq-vasicekdiscountcall_d2.\n\nRather than calculating $\\sigma_{\\text{avg}}$ from the volatility $\\sigma$ of the short rate and the constant $\\kappa$ or function $\\kappa_t$, we will treat $\\sigma_{\\text{avg}}$ as an input into the option pricing formulas.  This is necessary if one wants to use (i.e., invert) the following functions to imply $\\sigma_{\\text{avg}}$ from market prices and then used the implied $\\sigma_{\\text{avg}}$ to calibrate the model.\n\n::: {#discount_bond_option .cell execution_count=2}\n``` {.python .cell-code code-fold=\"true\"}\nimport numpy as np\nfrom scipy.stats import norm\n\ndef black_call(F, K, P, sigma, T):\n    d1 = (np.log(F / K) + 0.5 * sigma ** 2 * T) / (sigma * np.sqrt(T))\n    d2 = d1 - sigma * np.sqrt(T)\n    return P * (F * norm.cdf(d1) - K * norm.cdf(d2))\n\ndef black_put(F, K, P, sigma, T):\n    d1 = (np.log(F / K) + 0.5 * sigma ** 2 * T) / (sigma * np.sqrt(T))\n    d2 = d1 - sigma * np.sqrt(T)\n    return P * (K * norm.cdf(-d2) - F * norm.cdf(-d1))\n\ndef vasicek_discount_bond_call(Underlying, K, MatDisc, sigavg, T):\n    F = Underlying / MatDisc\n    return black_call(F, K, MatDisc, sigavg, T)\n\ndef vasicek_discount_bond_put(Underlying, K, MatDisc, sigavg, T):\n    F = Underlying / MatDisc\n    return black_put(F, K, MatDisc, sigavg, T)\n\n\n# Example usage\nUnderlying = 0.9\nK = 0.9\nMatDisc = 0.88\nsigavg = 0.2\nT = 1\n\n\nprint(\"Vasicek Discount Bond Call:\", vasicek_discount_bond_call(Underlying, K, MatDisc, sigavg, T))\nprint(\"Vasicek Discount Bond Put:\", vasicek_discount_bond_put(Underlying, K, MatDisc, sigavg, T))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nVasicek Discount Bond Call: 0.13463704635261298\nVasicek Discount Bond Put: 0.026637046352613162\n```\n:::\n:::\n\n\nAs noted before, these option pricing formulas can be used to value caplets and floorlets.  \\index{caplet}\\index{floorlet}A caplet with reset date $t_i$ and payment date $t_{i+1}$ is equivalent, as discussed in @sec-s:caps2, to $1+\\bar{R}\\,\\Delta$ put options maturing at $t_i$ on the discount bond maturing at $t_{i+1}$, with the exercise price of each option being $1/(1+\\bar{R}\\,\\Delta t)$.  When we make these substitutions in the above formulas (and the same for floorlets) we obtain the following.\n\n::: Rule\n## \nConsider a caplet and a floorlet with reset date $t_i$ and payment date $t_{i+1}$.  Define $\\Delta t = t_{i+1}-t_i$.  Let $\\bar{R}$ denote the cap and floor rate.  In the extended Vasicek model, the values at date $0$ of the caplet and floorlet are as follows.\n\n\n$$\n\\text{Floorlet Price} =(1+\\bar{R}\\,\\Delta t)P^{\\text{mkt}}(0,t_{i+1})\\mathrm{N}(d_1) - P^{\\text{mkt}}(0,t_i)\\mathrm{N}(d_2)\\;,\n$$ {#eq-vasicekfloorlet}\n\n$$\n\\text{Caplet Price} = P^{\\text{mkt}}(0,t_i)\\mathrm{N}(-d_2)-(1+\\bar{R}\\,\\Delta t)P^{\\text{mkt}}(0,t_{i+1})\\mathrm{N}(-d_1)\\;,\n$$ {#eq-vasicekcaplet}\n\n\nwhere\n\n$$\nd_1 = \\frac{\\log\\left((1+\\bar{R}\\,\\Delta t)P^{\\text{mkt}}(0,t_{i+1})\\right) -\\log P^{\\text{mkt}}(0,t_i)  +\\frac{1}{2}\\sigma_{\\text{avg}}^2t_i}{\n\\sigma_{\\text{avg}}\\sqrt{t_i}}\\;,\n$$ {#eq-vasicekcaplet_d1}\n\n$$\nd_2 = d_1 - \\sigma_{\\text{avg}}\\sqrt{t_i}\\;, \n$$ {#eq-vasicekcaplet_d2}\n\n\nThe volatility $\\sigma_{\\text{avg}}$ is defined as $\\sigma\\,\\Delta t$ in the continuous-time Ho-Lee model and as\n$$\n\\sigma_{\\text{avg}} = \\frac{\\sigma \\mathrm{e}^{-\\kappa t_i}\\left(1- \\mathrm{e}^{-\\kappa \\,\\Delta t}\\right) }{\\kappa}\\sqrt{\\frac{\\mathrm{e}^{2\\kappa t_i}-1}{2\\kappa t_i}}\n$$ {#eq-vasicekvbacap}\nin the Hull-White model.\n\n:::\n\n\n\nA reasonable way to choose the parameter $\\sigma$ in the continuous-time Ho-Lee model and the parameters  $\\kappa$ and $\\sigma$ in the  Hull-White model would be to fit the model as well as possible to market prices of caps and/or floors.  The function $\\phi_t$ can then be chosen as discussed in the preceding section.  \n\nWe also used Black's formula to value caplets and floorlets in @sec-s:valuingcaps.  However, the formulas in this section and the formulas in @sec-s:valuingcaps give different values, because they are based on different assumptions.  In the Vasicek model and its extensions, the forward price \n$$\nF_t = \\frac{P(t,t_{i+1})}{P(t,t_i)}\n$$\nof the discount bond corresponding to the caplet with payment date $t_{i+1}$ has a non-random volatility, and this is the assumption on which  @eq-vasicekfloorlet - @eq-vasicekcaplet is based.  In @sec-s:valuingcaps, we assumed the forward LIBOR rate had a non-random volatility.  The definition~@eq-forward2 of the forward rate is\n$$\nR_i_t = \\frac{P(t,t_i)}{P(t,t_{i+1})} - 1 = \\frac{1}{F_t}-1\\;.$$\nIf the forward price has a non-random volatility, then the forward rate is the sum of a variable ($1/F_t$) with a constant volatility and a constant ($-1$) and hence will have a random volatility.  Likewise, if the forward rate has a non-random volatility, then the forward price will have a random volatility.  Therefore, the assumptions of the two models are inconsistent.\n\n::: {#vasicek_cap .cell execution_count=3}\n``` {.python .cell-code code-fold=\"true\"}\ndef vasicek_cap(P0, P, rbar, sigavg, N, t0, dt):\n    K = 1 / (1 + rbar * dt)\n    if t0 == 0:\n        cap_value = P[0] * max(0, 1 / P[0] - 1 - rbar * dt)\n    else:\n        MatDisc = P0\n        Underlying = P[0]\n        cap_value = vasicek_discount_bond_put(Underlying, K, MatDisc, sigavg[0], t0)\n    \n    for i in range(1, N):\n        MatDisc = P[i - 1]\n        Underlying = P[i]\n        mat = t0 + i * dt\n        cap_value += vasicek_discount_bond_put(Underlying, K, MatDisc, sigavg[i], mat)\n    \n    return (1 + rbar * dt) * cap_value\n\n# Example\n\nP0 = 0.95\nP = [0.92, 0.89, 0.85, 0.80]\nrbar = 0.03\nN = 4\nt0 = 0.5\ndt = 0.5\n\nprint(\"Vasicek Cap:\", vasicek_cap(P0, P, rbar, [0.2, 0.18, 0.15, 0.12], N, t0, dt))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nVasicek Cap: 0.2915227189677007\n```\n:::\n:::\n\n\n## Coupon Bond Options and Swaptions {#sec-s:vasicek_swaptions}\n\nIn this section, we will discuss the valuation of coupon bond options \\index{coupon bond option}in the extended Vasicek models.  As discussed in @sec-s:swaptionscouponbondoptions, swaptions \\index{swaption} are equivalent to options on coupon bonds, so the valuation methods can also be applied to swaptions.\n\nConsider a bond paying a coupon of \\$$c$ at dates $t_1, t_2, \\ldots, t_N$ and its face value of \\$1 at date $t_N$.  Consider a European call option on the bond maturing at date $T$.  In the case of a European swaption, all of the coupon payment dates occur after the option maturity ($t_i > T$ for $i=1,\\ldots,N$), and the coupon is taken to be $c=\\bar{R}\\,\\Delta t$, where $\\bar{R}$ is the swap rate.  In the case of an option on a coupon bond, some of the coupons may occur before the option maturity, but naturally the value of the option depends only on the coupons that occur after the option matures, because those are the only coupons to which an exerciser of the option would be entitled.  By focusing only on those coupons, we can take $t_i > T$ for $i=1,\\ldots,N$.\n\n\n\nA coupon bond is a portfolio of discount bonds, so an option on a coupon bond is an option on a portfolio of discount bonds.  In general, an option on a portfolio is worth less than a portfolio of options, so an option on a coupon bond should be worth less than a portfolio of discount bond options.  However, in any single-factor model, \\index{single-factor model}it is possible to define the strike prices of the discount bond options so that the option on the coupon bond is worth exactly the same as a portfolio of discount bond options.^[This method was first described by Jamshidian [@Jamshidian89].]  This reduces the valuation problem for coupon bond options to the problem of valuing discount bond options, which we have already solved for this model.  We will use the same technique in @sec-s:captions to value options on caps (captions) and options on floors (floortions).\n\nAs shown in  @eq-extendedvasicekbond, the single factor that determines all discount bond prices in this model is the random variable $\\hat{r}$.  We let $r^*$ denote the value of $\\hat{r}_T$ such that, according to the model, the coupon bond option will be at the money at maturity when $\\hat{r}_T=r^*$.  Being at the money means of course that\n$$\n\\sum_{i=1}^N cP(T,t_i) + P(T,t_N) = K\\;.\n$$ {#eq-swaptions101}\n\nThus, based on @eq-extendedvasicekbond for the discount bond prices, we define $r^*$ by\n\n$$\n\\begin{multline}\n\\sum_{i=1}^N c\\exp\\left(-\\int_T^{t_i} \\phi_s\\d   s-a(t_i-T)-b(t_i-T)r^*\\right) \\\\+ \\exp\\left(-\\int_T^{t_N} \\phi_s\\d   s-a(t_N-T)-b(t_N-T)r^*\\right) = K\\;. \n\\end{multline}\n$$ {#eq-swaptions102}\n\nAccording to the model, if $\\hat{r}_T$ is lower than $r^*$, then the bond prices will be higher and the call option will be in the money; conversely, if $\\hat{r}_T$ is higher than $r^*$, then the bond prices will be lower and the call option will be out of the money.  \n\nFor $i=1,\\ldots,N$, define $K_i$ to be the model value of the discount bond price $P(T,t_i)$ when $\\hat{r}_T=r^*$.  In other words, define $K_i$ as \n$$\nK_i = \\exp\\left(-\\int_T^{t_i} \\phi_s\\d   s-a(t_i-T)-b(t_i-T)r^*\\right)\\;.\n$$ {#eq-swaptions103}\n\nNote that equations @eq-swaptions102 and @eq-swaptions103 imply\n$$\n\\sum_{i=1}^N cK_i + K_N = K\\; .\n$$ {#eq-swaption100000}\n\n\nConsider for each $i$ ($i=1,\\ldots,N$) a hypothetical call option maturing at $T$ with the underlying for the option being the discount bond maturing at $t_i$.  Let $K_i$ be the exercise price of option $i$.  According to the model, the value of the underlying at date $T$ for option $i$ will be \n$$\nP(T,t_i) = \\exp\\left(-\\int_T^{t_i} \\phi_s\\d   s-a(t_i-T)-b(t_i-T)\\hat{r}_T\\right)\\;.\n$$\nBy the definition of $K_i$, therefore, option $i$ will be in the money if and only if \n$\\hat{r}_T < r^*$.\nThus, all of the options are in (or out) of the money in the same circumstances.  \n\nNow consider the portfolio consisting of $c$ units of option $i$ for $i=1,\\ldots,N-1$ and $1+c$ units of option $N$.  According to the model, the value of the portfolio will be zero at date $T$ if $\\hat{r}_T \\geq r^*$, and, if $\\hat{r}_T<r^*$, it follows from @eq-swaption100000 that the value of the portfolio will be \n$$\n\\sum_{i=1}^{N-1}c\\big[P(t,t_i)-K_i\\big]+ (1+c)\\big[P(t,T_N)-K_N\\big] \n= \\sum_{i=1}^NcP(t,t_i)+ P(t,T_N) - K,\n$$\nwhich is the intrinsic value of the coupon bond option when $r_T<r^*$.  Therefore, according to the model,  the coupon bond option is equivalent to this portfolio of discount bond options.  We can value the discount bond options from the formulas in the previous section and then value the portfolio and hence the coupon bond option by summing.\nThe same type of reasoning also allows us to value put options on coupon bonds.\n\nThe only issue in implementing this method is that we need to compute the exercise prices $K_i$.  Of course, we define them by  @eq-swaptions103, given $r^*$.  To do this requires that we calculate the factor\n$$\n\\exp\\left(-\\int_T^{t_i} \\phi_s\\d   s\\right),\n$$ {#eq-vasicekfactor100}\n\nby fitting the model to market bond prices, as discussed in @sec-s:vasicek_fitting.  We will explain this more explicitly in the next paragraph.  In order to apply equation~@eq-swaptions103, we need to compute $r^*$, which is given by equation~@eq-swaptions102.  We can solve~@eq-swaptions102 for $r^*$ by bisection or some other root-finding method.  Again, we need to know the factors @eq-vasicekfactor100\n in order to solve this equation.\n\nTo compute the factors @eq-vasicekfactor100,\nwe use  @eq-vasicekcalibration101.  We repeat it here twice, for maturity dates $t_i$ and $T$:\n\\begin{align*}\n\\exp\\left(-\\int_0^{t_i} \\phi_s\\d   s\\right) &= \\exp\\left(a_{t_i}+b_{t_i}r_0\\right)P^{\\text{mkt}}(0,t_i)\\; ,\\\\\n\\exp\\left(-\\int_0^{T} \\phi_s\\d   s\\right) &= \\exp\\left(a_T+b_Tr_0\\right)P^{\\text{mkt}}(0,T)\\;.\n\\end{align*}\nIf we divide the top equation by the bottom, then on the left-hand side we obtain\n\\begin{align*}\n\\frac{\\exp\\left(-\\int_0^{t_i} \\phi_s\\d   s\\right)}{\\exp\\left(-\\int_0^{T} \\phi_s\\d   s\\right)} &= \\exp\\left(-\\int_0^{t_i} \\phi_s\\d   s + \\int_0^{T} \\phi_s\\d   s\\right) \\\\\n&= \\exp\\left(-\\int_T^{t_i} \\phi_s\\d   s\\right)\\; ,\n\\end{align*}\nwhich is the number we want.  Hence, we obtain by dividing the right-hand sides of the above equations:\n$$\n\\exp\\left(-\\int_T^{t_i} \\phi_s\\d   s\\right) = \\exp\\left\\{a_{t_i}-a_T + [b_{t_i}-b_T]r_0\\right\\}\\frac{P^{\\text{mkt}}(0,t_i)}{P^{\\text{mkt}}(0,T)}\\;.\n$$ {#eq-swaptions104}\n\n::: {#hw_coupon_bond_call .cell execution_count=4}\n``` {.python .cell-code code-fold=\"true\"}\ndef hwa(sigma, kappa, tau):\n    return -sigma ** 2 * (2 * kappa * tau - np.exp(-2 * kappa * tau) + 4 * np.exp(-kappa * tau) - 3) / (4 * kappa ** 3)\n\ndef hwb(kappa, tau):\n    return (1 - np.exp(-kappa * tau)) / kappa\n\ndef hwsigavg(sigma, kappa, T, u):\n    return max((sigma * (np.exp(-kappa * T) - np.exp(-kappa * u)) / kappa) * np.sqrt((np.exp(2 * kappa * T) - 1) / (2 * kappa * T)),0.001)\n\ndef hw_coup_bond(Coup, N, t1, dt, Cal, r, sigma, kappa, T):\n    x = 0\n    for i in range(N - 1):\n        tau = t1 + i * dt - T\n        a = hwa(sigma, kappa, tau)\n        b = hwb(kappa, tau)\n        x += Coup * Cal[i] * np.exp(-a - b * r)\n    \n    tau = t1 + (N - 1) * dt - T\n    a = hwa(sigma, kappa, tau)\n    b = hwb(kappa, tau)\n    x += (1 + Coup) * Cal[N - 1] * np.exp(-a - b * r)\n    \n    return x\n\ndef hw_coup_bond_call(Coup, N, t1, dt, K, MatDisc, P, r, sigma, kappa, T):\n    tol = 1e-8\n    Cal = np.zeros(N)\n    \n    aT = hwa(sigma, kappa, T)\n    bT = hwb(kappa, T)\n    for i in range(N):\n        tau = t1 + i * dt\n        a = hwa(sigma, kappa, tau)\n        b = hwb(kappa, tau)\n        Cal[i] = np.exp(a - aT + (b - bT) * r) * P[i] / MatDisc\n    \n    lower = 0\n    flower = hw_coup_bond(Coup, N, t1, dt, Cal, lower, sigma, kappa, T) - K\n    while flower < 0:\n        lower -= 1\n        flower = hw_coup_bond(Coup, N, t1, dt, Cal, lower, sigma, kappa, T) - K\n    \n    upper = 1\n    fupper = hw_coup_bond(Coup, N, t1, dt, Cal, upper, sigma, kappa, T) - K\n    while fupper > 0:\n        upper += 1\n        fupper = hw_coup_bond(Coup, N, t1, dt, Cal, upper, sigma, kappa, T) - K\n    \n    guess = 0.5 * (lower + upper)\n    fguess = hw_coup_bond(Coup, N, t1, dt, Cal, guess, sigma, kappa, T) - K\n    while upper - lower > tol:\n        if fupper * fguess < 0:\n            lower = guess\n            flower = fguess\n        else:\n            upper = guess\n            fupper = fguess\n        guess = 0.5 * (lower + upper)\n        fguess = hw_coup_bond(Coup, N, t1, dt, Cal, guess, sigma, kappa, T) - K\n    \n    rstar = guess\n    x = 0\n    \n    for i in range(N - 1):\n        tau = t1 + i * dt - T\n        a = hwa(sigma, kappa, tau)\n        b = hwb(kappa, tau)\n        strike = Cal[i] * np.exp(-a - b * rstar)\n        sigavg = hwsigavg(sigma, kappa, T, T + tau)\n        x += Coup * vasicek_discount_bond_call(P[i], strike, MatDisc, sigavg, T)\n    \n    tau = t1 + (N - 1) * dt - T\n    a = hwa(sigma, kappa, tau)\n    b = hwb(kappa, tau)\n    strike = Cal[N - 1] * np.exp(-a - b * rstar)\n    sigavg = hwsigavg(sigma, kappa, T, T + tau)\n    x += (1 + Coup) * vasicek_discount_bond_call(P[N - 1], strike, MatDisc, sigavg, T)\n    \n    return x\n\n# Example usage\n\nUnderlying = 0.95\nK = 0.9\nMatDisc = 0.88\nsigavg = 0.2\nT = 1\n\nP0 = 0.95\nP = [0.92, 0.89, 0.85, 0.80]\nrbar = 0.03\nN = 4\nt0 = 0.5\ndt = 0.5\n\nCoup = 0.03\nr = 0.02\nsigma = 0.1\nkappa = 0.1\n\n\nprint(\"HW Coupon Bond Call:\", hw_coup_bond_call(Coup, N, t0, dt, K, MatDisc, P, r, sigma, kappa, T))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nHW Coupon Bond Call: 0.11555572997069366\n```\n:::\n:::\n\n\n## Captions and Floortions {#sec-s:captions}\n\nIn this section, we will consider options on caps and floors, which are sometimes called captions and floortions \\index{caption} \\index{floortion}respectively.  For specificity, we will consider a call option on a cap.\nA cap is a portfolio of caplets, and each caplet is a call option on a spot rate.  Therefore a call option on a cap is a call option on a portfolio of calls on spot rates and hence is a bet on (or insurance against) high spot rates.  \n\nOf course, high spot rates are equivalent to low bond prices, so a call on a cap can also be seen as a bet on low bond prices.  We will actually take this latter approach and view a cap as a portfolio of put options on discount bonds, as in @sec-s:vasicek_discounts.  This means that we will analyze a call option on a cap as a call on a portfolio of puts.  We will use the trick of the previous section and reduce this call on a portfolio of puts to a portfolio of calls on puts.  Each call on a put is a compound option and can be valued as in @sec-c:exotics.  The assumptions made in @sec-c:exotics for compound options are valid here, because the forward prices of the discount bonds (which are the underlyings for the puts) have non-random volatilities in the extended Vasicek models.\n\nConsider a cap with reset dates $t_0,\\ldots t_{N-1}$ and payment dates $t_1,\\ldots, t_N$, with $t_{i+1}-t_i=\\Delta t$ for each $i$.  Let $\\bar{R}$ denote the fixed rate on the cap.  We consider a call option on the cap maturing at date $T \\leq t_0$ and having exercise price $K$.  In the model, the value of the cap at the option maturity will depend on the random variable $\\hat{r}_T$.  As in the previous section, we will let $r^*$ denote the value of $\\hat{r}_T$ such that the call option on the cap is at the money at date $T$ when $\\hat{r}_T=r^*$.  If $\\hat{r}_T>r^*$ then the cap will be more valuable, so the call will be in the money; conversely if $\\hat{r}_T<r^*$ the call will be out of the money.  Also, similar again to the previous section, we will let $K_i$ denote the value of the caplet with reset date $t_i$ and payment date $t_{i+1}$ ($i=0,\\ldots,N-1$) when $\\hat{r}_T=r^*$.  We consider hypothetical call options on the individual caplets with exercise prices $K_i$.  If $\\hat{r}_T>r^*$, then, according to the model, all of the calls on the caplets will be in the money, and the sum of their values will equal the value of the call on the cap.  On the other hand, if $\\hat{r}_T<r^*$ then all of the calls on the caplets will be out of the money, as will be the call on the cap.  Thus, the value of the call on the cap is the sum of the values of the calls on the caplets.  \nIn order to apply the methods developed in @sec-c:exotics for valuing compound options to value the calls on the caplets (i.e., the calls on puts on discount bonds), all we need to do is to calculate the rate $r^*$ and the exercise prices $K_i$.  We will explain this only briefly.\n\nConsider the caplet with payment date $t_{i+1}$.  According to the valuation @eq-vasicekcaplet, the value of the caplet at date $T$, when there is a remaining time to maturity of $t_i-T$, will be^[We use now the model prices for the discount bonds at date $T$.  Obviously, the market prices at the caption maturity date $T$ are unknown at date $0$, the date at which we are valuing the caption.] \n\n$$\n\\text{Caplet Value at Date $T$} = P(T,t_{i})N(-d_2) - (1+\\bar{R}\\Delta t)P(T,t_{i+1})N(-d_1)\\;,\n$$ {#eq-captions1}\n\nwhere\n\n$$\nd_1 = \\frac{\\log\\left((1+\\bar{R}\\Delta t)P(T,t_{i+1})\\right) - \\log P(T,t_{i})+\\frac{1}{2}\\sigma_{\\text{avg}}^2(t_{i}-T)}{\n\\sigma_{\\text{avg}}\\sqrt{t_{i}-T}}\\;,\n$$ {#eq-captions2}\n\n$$\nd_2 = d_1 - \\sigma_{\\text{avg}}\\sqrt{t_{i}-T}\\;.\n$$ {#eq-captions3}\n\n\n\nHere $\\sigma_{\\text{avg}}$ denotes the average volatility of the forward price of the discount bond between the option valuation date $T$ and the option maturity date $t_{i}$.  This shows that the values of the caplets and hence the value of the cap depend on the discount bond prices at date $T$, which, according to the model, depend on $\\hat{r}_T$.  One can use bisection or some other root-finding method again to find the value of $\\hat{r}_T$ such that, according to the model, the value of the cap will be $K$ at date $T$.  Substituting this value of $\\hat{r}_T$ into the bond pricing @eq-extendedvasicekbond - @eq-extendedvasicek_b and then substituting the bond prices $P(T,t_{i})$ and $P(T,t_{i+1})$ into @eq-captions1 - @eq-captions3, we define $K_i$  as the caplet value in  @eq-captions1.\n\n\n\n\n## Yields and Yield Volatilities {#sec-s:HW_yields}\n\nWe are denoting the price at date $t$ of a discount bond maturing at $u$, with remaining time to maturity of $\\tau = u-t$, as $P(t,u)$.  However, as in @sec-s:yieldcurve, we will denote the corresponding yield as $y(t,\\tau)$.  The yield is defined as \\index{discount bond yield}\n$$\ny(t,\\tau) = \\frac{-\\log P(t,u)}{\\tau}\\;.\n$$\nIn the extended Vasicek model, the yield is given by the bond pricing @eq-vasicekbond as\n$$\ny(t,\\tau) = \\frac{\\int_t^{t+\\tau} \\phi_s\\d   s + a(\\tau) + b(\\tau)\\hat{r}_t}{\\tau}\\;.\n$$\nNote that the component\n$$\n\\frac{a(\\tau) + b(\\tau)\\hat{r}_t}{\\tau}\n$$\nof the yield $y(t,t+\\tau)$ is independent of $t$, except for its dependence on $\\hat{r}_t$.  For example, in the continuous-time Ho-Lee model, this component equals\n$$\n-\\frac{\\sigma^2\\tau^2}{6} + \\hat{r}_t\\;.\n$$\nThis is a decreasing function of the time to maturity $\\tau$ with intercept equal to $\\hat{r}_t$.  At a different date $t$, this component of the yield curve would be the same, except for having a different intercept.^[Note that this part decreases to $-\\infty$ at long maturities ($\\tau \\rightarrow \\infty$), which is very strange for yields, which should be nonnegative.  To compensate for this strange behavior, one needs the part \n$$\n\\frac{1}{\\tau}\\int_t^{t+\\tau} \\phi_s\\d   s\\; ,\n$$\nwhich is the average of $\\phi_s$ between $t$ and $t+\\tau$ to be growing sufficiently with $\\tau$.  This phenomenon is a consequence of the absence of mean reversion.}  This is the reason for the statement in @sec-s:vasicekhedging that only parallel shifts in the yield curve are possible in this model (and hence duration hedging works in the model).\n\nThe volatility at date $t$ of the yield \\index{yield volatility}at a fixed maturity $\\tau$ is^[By volatility here we mean the instantaneous standard deviation of $\\d  y(t,\\tau)$ not the instantaneous standard deviation of $\\d  y(t,\\tau)/y(t,\\tau)$.} $\\sigma b(\\tau)/\\tau$.\nIn the continuous-time Ho-Lee model, this is $\\sigma$ and in the  Hull-White model it is $\\sigma\\left(1-\\mathrm{e}^{-\\kappa\\tau}\\right)/(\\kappa\\tau)$.  In @sec-s:vasicek_discounts we mentioned that one might choose the parameter $\\sigma$ in the Ho-Lee model and the parameters $\\sigma$ and $\\kappa$ in the  Hull-White model to fit cap or floor prices as well as possible.  An alternative would be to choose them to match estimated yield volatilities.  Of course the fit to either cap prices or yield volatilities will be of limited quality, given that there is only one or two parameters in these models.  On the other hand, an exact fit can be obtained with the general Hull-White model.\n\n\n\n## The General Hull-White Model {#sec-s:generalHW}\n\nWe will briefly discuss the general Hull-White model, in which\n$$\n\\d  r_t = \\theta_t\\d   t -\\kappa_tr_t\\d   t + \\sigma_t\\d   B_t\\;.\n$$ {#eq-hw600}\n\nBy differentiating the following, one can see that the short rate $r$ in the general Hull-White model satisfies\n\n$$\nr_s = \\phi_s + \\hat{r}_s\\;,\n$$ {#eq-hw601}\n\nwhere\n$$\n\\phi_s =  \\int_0^s\\exp\\left(-\\int_y^s\\kappa(x)\\d   x\\right)\\theta(y)\\d   y\\;.\n$$ {#eq-phi101}\n\nand\n$$\n\\hat{r}_s = \\exp\\left(-\\int_0^s\\kappa(x)\\d   x\\right)r_0+\\int_0^s\\exp\\left(-\\int_y^s\\kappa(x)\\d   x\\right)\\sigma(y)\\d   B(y)\\;.\n$$ {#eq-rhat101}\n\n\nAs before, discount bond prices are\n$$\nP(t,u) = \\exp\\left(-\\int_t^u \\phi_s\\d   s\\right)\\\\E^R_t \\left[ \\exp\\left(-\\int_t^u \\hat{r}_s\\d   s\\right)\\right]\\;.\n$$ {#eq-hw602}\n\nMoreover,  @eq-rhat101 implies, for $s>t$, \n\n$$\n\\hat{r}_s = \\exp\\left(-\\int_t^s\\kappa(x)\\d   x\\right)\\,\\hat{r}_t+\\int_t^s\\exp\\left(-\\int_y^s\\kappa(x)\\d   x\\right)\\sigma(y)\\d   B(y)\\;.\n$$ {#eq-rhat1001}\n\nUsing this fact, the expectation in @eq-hw602 can be calculated as before as the expectation of the exponential of a normally distributed random variable, leading to the result\n\n$$\nP(t,u) = \\exp\\left(-\\int_t^u \\phi_s\\d   s-a(t,u)-b(t,u)\\hat{r}_t\\right)\\;,\n$$ {#eq-hw603}\n\nwhere\n\n$$\nb(t,u) = \\int_t^u \\exp\\left(-\\int_t^s\\kappa(x)\\d   x\\right)\\d   s\\; ,\n$$\n$$\na(t,u) =  -\\frac{1}{2}\\int_t^u b(y,u)^2\\sigma(y)^2\\d   y\\;.\n$$\n\nNote that the functions $a$ and $b$ now depend on the date $t$ of valuation and the date $u$ of maturity rather than being determined entirely by the time to maturity $u-t$.  Note also that we can write\n\n$$\nb(t,u) = \\exp\\left(\\int_0^t\\kappa(x)\\d   x\\right)\\int_t^u\\exp\\left(-\\int_0^s\\kappa(x)\\d   x\\right)\\d   s\n$$\n$$\n= \\exp\\left(\\int_0^t\\kappa(x)\\d   x\\right)\n$$\n$$\n\\qquad \\times\\left[\\int_0^u\\exp\\left(-\\int_0^s\\kappa(x)\\d   x\\right)\\d   s - \\int_0^t\\exp\\left(-\\int_0^s\\kappa(x)\\d   x\\right)\\d   s\\right]\n$$\n$$\n=\\exp\\left(\\int_0^t\\kappa(x)\\d   x\\right)\\big(b(0,u)-b(0,t)\\big)\\;.\n$$ {#eq-hw2btu}\n\n\nTherefore, we can recover the functions $b(t,u)$ and  $a(t,u)$ from the functions $b(0,t)$, $\\exp\\left(\\int_0^t\\kappa(x)\\d   x\\right)$, and $\\sigma_t$.\n\n\\vfil\\eject\nThe returns of discount bonds satisfy\n$$\n\\frac{\\d  P(t,u)}{P(t,u)} = r_t\\d   t - \\sigma_t b(t,u)\\d   B_t\\;.\n$$ {#eq-extendedvasicekbondreturn2}\n\nHence, hedge ratios, which depend on relative volatilities, are  determined by the function $b$ as before.  Given the functions $\\kappa$ and $\\sigma$, the model can be calibrated to market discount bond prices by choosing the function $\\phi$ exactly as discussed in @sec-s:vasicek_fitting.  \n\nThe pricing of fixed-income derivatives discussed in @sec-s:vasicek_discounts - \\ref{s_captions} was based on  forward prices of discount bonds having non-random volatilities.  This is true also in the general Hull-White model.  Given dates $t<T<u$, the forward price at date $t$ of the discount bond maturing at date $u$, when the forward contract matures at $T$, is, as before, $F_t=P(t,u)/P(t,T)$.  In the general Hull-White model, we have\n\\begin{align*}\n\\frac{\\d  F_t}{F_t} &= \\text{something}\\d   t + \\frac{\\d  P(t,u)}{P(t,u)} - \\frac{\\d  P(t,T)}{P(t,T)}\\\\\n&= \\text{something}\\d   t -\\sigma_t[b(t,u)-b(t,T)]\\d   B_t\\\\\n&= \\text{something}\\d   t -\\sigma_t\\exp\\left(\\int_0^t\\kappa(x)\\d   x\\right)\\big[b(0,u)-b(0,T)\\big]\\d   B_t\\;.\n\\end{align*}\nThus, the average volatility, from date $0$ to date T, is \n$$\\sigma_{\\text{avg}} = \\big[b(0,u)-b(0,T)\\big]\\sqrt{\\frac{1}{T}\\int_0^T \\sigma_t^2\\exp\\left(2\\int_0^t\\kappa(x)\\d   x\\right)\\d   t}\\; .$$\nWith this substitution,  the pricing of fixed-income derivatives is the same as in the basic Hull-White model discussed in @sec-s:vasicek_discounts--@sec-s:captions.\n\n\nThe advantage of the general Hull-White model is that it allows more flexibility in fitting the model to current market conditions.  This may (though there is certainly no guarantee) provide better pricing and hedging of interest-rate derivatives.  Hull and White suggest choosing the volatility function $\\sigma$ to fit anticipated future volatilities of the short rate and choosing the mean-reversion function $\\kappa$ to fit market cap/floor prices or yield volatilities.  \nWe will assume that the volatility function $\\sigma$ has been chosen, and we will describe how to choose the mean-reversion function to fit the model to estimated yield volatilities or cap prices.  As usual, we let date $0$ denote the date at which we are fitting the model.\n\n\n\nThe simplest approach is to take the function $\\kappa_t$ to be piecewise constant.  Consider dates $0=t_0 < t_1 < \\cdots t_M$ with $t_i-t_{i-1}=\\Delta t$ for each $i$.  For valuing a swaption, for example, we would want $t_M$ to be the sum of the time to maturity of the swaption and the length of the swap.  Thus, we are fitting the model until the end of the swap underlying the swaption.  We want to find numbers $\\kappa_1,\\ldots,\\kappa_M$ and will set the function $\\kappa$ to equal $\\kappa_i$ for $t$ between $t_{i-1}$ and $t_i$.\n\nGiven this definition, we have\n\\begin{align*}\n\\exp\\left(-\\int_0^{t_1}\\kappa(x)\\d   x\\right) &= \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\; ,\\\\\n\\exp\\left(-\\int_0^{t_2}\\kappa(x)\\d   x\\right) &= \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\mathrm{e}^{-\\kappa_2\\,\\Delta t}\\; ,\\\\\n\\exp\\left(-\\int_0^{t_3}\\kappa(x)\\d   x\\right) &= \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\mathrm{e}^{-\\kappa_2\\,\\Delta t}\\mathrm{e}^{-\\kappa_3\\,\\Delta t}\\;,\n\\end{align*}\netc.  Furthermore,\n\\begin{align*}\nb(0,t_1) &= \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\Delta t\\; ,\\\\\nb(0,t_2) &= \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\,\\Delta t + \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\mathrm{e}^{-\\kappa_2\\,\\Delta t}\\,\\Delta t\\; ,\\\\\nb(0,t_3) &= \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\,\\Delta t + \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\mathrm{e}^{-\\kappa_2\\,\\Delta t}\\,\\Delta t + \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\mathrm{e}^{-\\kappa_2\\,\\Delta t}\\mathrm{e}^{-\\kappa_3\\,\\Delta t}\\,\\Delta t\\;,\n\\end{align*}\netc.\nThis yields the following recursive structure for the $b(0,t_i)$.\n\n\n$$\nb(0,t_1) = \\mathrm{e}^{-\\kappa_1\\,\\Delta t}\\Delta t\\; ,\n$$ {#eq-generalhwrecursive1}\n$$\nb(0,t_2) = b(0,t_1) + b(0,t_1)\\mathrm{e}^{-\\kappa_2\\,\\Delta t}\\; ,\n$$\n$$\n(\\forall i \\geq 3) \\quad b(0,t_i) = b(0,t_{i-1}) + [b(0,t_{i-1})-b(0,t_{i-2})]\\mathrm{e}^{-\\kappa_i\\,\\Delta t}\\;.\n$$ {#eq-generalhwrecursive3}\n\n\nMatching the yield volatilities in the model to estimated market volatilities is extremely simple.  The same analysis presented in @sec-s:HW_yields for the basic Hull-White model shows that  the volatility at date $0$ of the yield at maturity $t_i$ in the general Hull-White model  is\n$$\n\\frac{\\sigma_0 b(0,t_i)}{t_i}\\;.\n$$\nGiven the estimated yield volatility, we can define $b(0,t_i)$ by equating the model volatility to the estimated volatility.  Using @eq-generalhwrecursive1 - @eq-generalhwrecursive3, the $\\kappa_i$ can be computed from the $b(0,t_i)$ for $i=1,2,\\ldots$.\n\nIt is equally easy to match the model to market cap or floor prices.  Suppose we have estimated implied volatilities  for caplets using the pricing @eq-vasicekfloorlet - @eq-vasicekcaplet.  Suppose the first caplet has reset date $t_1$ and payment date $t_2$, the second has reset date $t_2$ and payment date $t_3$, etc.  According to the model, the average volatility of the forward price of the discount bond underlying the caplet with reset date $t_i$ and payment date $t_{i+1}$ is\n$$\n \\big[b(0,t_{i+1})-b(0,t_i)\\big]\\sqrt{\\frac{1}{t_i}\\int_0^{t_i} \\sigma_t^2\\exp\\left(2\\int_0^t\\kappa(x)\\d   x\\right)\\d   t}\\;.\n $$\nNotice that everything in this expression, except $b(0,t_{i+1})$, is\ndetermined by $\\kappa_1,\\ldots,\\kappa_i$ and the $\\sigma$ function.  Therefore, we can select the number $b(0,t_{i+1})$ to match the model volatility to the implied volatility for this caplet.  This defines $\\kappa_{i+1}$ from @eq-generalhwrecursive1 - @eq-generalhwrecursive3.  Continuing in this way, we can successively define $\\kappa_1, \\kappa_2, \\ldots.$\n\n\n## {.unnumbered}\n\n::: Exercise\n Modify the function `Vasicek_Cap` so that rather than taking the vector $P$ of discount bond prices as an input, it looks up discount bond prices from a function `DiscountBondPrice` that returns a discount bond price for any maturity, as in Exercise~\\ref{c_fixedincomederivatives}.\\ref{exercise121}.\n:::\n::: Exercise\n Create a Python function `ContinuousHoLee_Cap` by modifying the function `Vasicek_Cap` so that the average volatilities are computed as $\\sigma\\Delta t$.  In other words, input $\\sigma$ rather than the vector $\\sigma_{\\text{avg}}$.  Write the function so that it looks up discount bond prices as in the previous exercise.\n:::\n::: {#exr-e_holeeimplied}\n Create a Python function `ContinuousHoLee_ImpliedVol` using bisection that takes the same inputs as the previous function, except taking a cap price as input rather than $\\sigma$, and which returns the volatility $\\sigma$ that is consistent with the cap price.\n:::\n::: Exercise\n Create a Python function `HW_Cap` by modifying the function `Vasicek_Cap` so that the average volatilities are calculated from equation~@eq-vasicekvbacap.  Thus, $\\sigma$ and $\\kappa$ should be input rather than the vector $\\sigma_{\\text{avg}}$.  Write the function so that it looks up discount bond prices as in the previous exercises.\n:::\n::: Exercise\n Create a Python code in which the user inputs $\\bar{r}$, $\\sigma$ and $\\kappa$.  Compute the values of caps using the function `HW_Cap` for caps of length $N = 1, \\ldots 20$.  Take $t_0=0$ and $\\Delta t=0.5$ and look up discount bond prices.  For each $N$, use the function created in Exercise~\\ref{c_vasicek}.\\ref{e_holeeimplied} to compute the volatility $\\sigma$ for which the `ContinuousHoLee_Cap` function gives the same cap price.  In other words, compute the implied Ho-Lee volatilities, given the cap prices.  What is the pattern in implied volatilities and why?\n:::\n::: Exercise\n Create a Python function `Vasicek_Floor` to value a floor in the extended Vasicek model, looking up discount bond prices from the `DiscountBondPrice` function.\n:::\n::: Exercise\n Modify the function `HW_Coup_Bond_Call` so that it looks up discount bond prices from the  `DiscountBondPrice` function.\n:::\n::: Exercise\n Create a Python function `HW_Coup_Bond_Put` to value a put option on a coupon bond in the basic Hull-White Model, looking up discount bond prices from the `DiscountBondPrice` function.\n:::\n::: Exercise\n Create a Python function `HW_Payer_Swaption` to value a payer swaption in the basic Hull-White Model, looking up discount bond prices from the `DiscountBondPrice` function.\n:::\n::: Exercise\n Create a Python function `HW_Receiver_Swaption` to value a receiver swaption in the basic Hull-White Model, looking up discount bond prices as in previous exercises.\n:::\n::: Exercise\n Repeat @exr-e_eicchorn, assuming the basic Hull-White Model, for various values of $\\sigma$ and $\\kappa$.\n:::\n\n",
    "supporting": [
      "Chapter_Vasicek_files\\figure-html"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n<script type=\"text/javascript\">\nwindow.PlotlyConfig = {MathJaxConfig: 'local'};\nif (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: \"STIX-Web\"}});}\nif (typeof require !== 'undefined') {\nrequire.undef(\"plotly\");\nrequirejs.config({\n    paths: {\n        'plotly': ['https://cdn.plot.ly/plotly-2.35.2.min']\n    }\n});\nrequire(['plotly'], function(Plotly) {\n    window._Plotly = Plotly;\n});\n}\n</script>\n\n"
      ]
    }
  }
}