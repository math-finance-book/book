{
  "hash": "7d667bebad17a63fcbea77ece55c9620",
  "result": {
    "engine": "jupyter",
    "markdown": "\\newcommand{\\d}{\\,\\mathrm{d}}\n\\newcommand{\\e}{\\mathrm{e}}\n\\newcommand{\\E}{\\mathbb{E}}\n\n\n\n# Merton, Black, and Margrabe {#sec-c:forwardexchange} \n\n::: {.cell execution_count=1}\n\n::: {.cell-output .cell-output-display}\n```\nUnable to display output for mime type(s): text/html\n```\n:::\n\n::: {.cell-output .cell-output-display}\n```\n<IPython.core.display.HTML object>\n```\n:::\n:::\n\n\nIn this chapter, we will derive three important generalizations of the Black-Scholes formula.  We will derive them from the Black-Scholes formula, which shows that all of the formulas are equivalent.  We will start with Margrabe's [@Margrabe] formula for an option to exchange one asset for another.  Standard calls and puts are special cases, involving the exchange of cash for an asset or an asset for cash.  From Margrabe's formula, we will derive Black's [@Black] formulas for options on forward and futures contracts.  Then, from Black's formulas, we will derive Merton's [@Merton] formulas for calls and puts in the absence of a constant risk-free rate.  \n\nUnless explicitly stated otherwise, we will not assume in this chapter the existence of a risk-free asset (or even an instantaneously risk-free asset as described in @sec-c:arbitrage).  This implies that the market is incomplete and there are many risk-neutral probabilitys.  Nevertheless, we can price exchange options, forward and futures options, and stock options by arbitrage.  Understanding this issue is not essential for deriving the formulas in this chapter---as mentioned, they will all be derived from the Black-Scholes formula---but the issue is nonetheless important.  It is discussed in the final section of the chapter.\n\nNaturally, all of the option-pricing formulas discussed in this chapter are quite similar.  The similarity can be seen from the Black-Scholes formula for a call option, which we can write as follows (replacing $d_1$ by $x$ and $d_2$ by $y$):\n$$\n\\mathrm{e}^{-qT}S_0\\mathrm{N}(x) - \\mathrm{e}^{-rT}K\\mathrm{N}(y)\\;,\n$$ {#eq-blackscholesagain}\n\nwhere\n\n$$ \nx=\\frac{\\log\\left(\\frac{S_0}{K}\\right)+\\left(r-q+\\frac{1}{2}\\sigma^2\\right)T}{\\sigma\\sqrt{T}}\n$$ {#eq-d1again}\n\n$$\ny = x -\\sigma\\sqrt{T}\\;.\n$$ {#eq-d2again}\n\n\nNote that $\\mathrm{e}^{-qT}S_0$ is the present value at date $0$ of the stock that would be acquired if the option is exercised, because it is the cost that one must pay at date $0$ to have one share of the stock at date $T$ with no withdrawal of dividends in the interim.  Obviously, $\\mathrm{e}^{-rT}K$ is the present value of the cash that is paid if the option is exercised.  Moreover, $x$ is equal to\n$$\\frac{\\log \\left(\\frac{\\mathrm{e}^{-qT}S_0}{\\mathrm{e}^{-rT}K} \\right)+ \\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\; ,$$\nand the logarithm in the numerator is of the ratio of present values.  All of the option pricing formulas in this chapter have the same form:  the present value of the asset to be acquired multiplied by $\\mathrm{N}(x)$ minus the present value of the asset to be delivered multiplied by $\\mathrm{N}(y)$.  Moreover in each case $x$ is the logarithm of the ratio of present values plus one-half $\\sigma^2T$ all divided by $\\sigma\\sqrt{T}$, and in each case $y$ is defined by @eq-d2again.  Notice that the Black-Scholes put option formula has this structure also.  The Black-Scholes put option formula is\n$$\n\\mathrm{e}^{-rT}K\\mathrm{N}(x) - \\mathrm{e}^{-qT}S_0\\mathrm{N}(y)\\;,\n$$ {#eq-blackscholesputagain}\n\nwhere\n\n$$\nx =-d_2\n =  - \\frac{\\log\\left(\\frac{S_0}{K}\\right)+\\left(r-q-\\frac{1}{2}\\sigma^2\\right)T}{\\sigma\\sqrt{T}}\n$$\n$$\n=\\frac{\\log \\left(\\frac{\\mathrm{e}^{-rT}K}{\\mathrm{e}^{-qT}S_0} \\right)+ \\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-d2again2}\n\n$$\ny=-d_1\n = - \\frac{\\log\\left(\\frac{S_0}{K}\\right)+\\left(r-q+\\frac{1}{2}\\sigma^2\\right)T}{\\sigma\\sqrt{T}}\n=x - \\sigma\\sqrt{T}\\;.\n$$\nThis similarity is discussed further in later, where the pricing formulas are implemented in Python.\n\n\n\n## Margrabe's Formula {#sec-s:margrabe}\n\nConsider two assets with prices $S_1$ and $S_2$ and a European option to exchange asset 2 for asset 1 at date $T$.  The value of the option at maturity is\n$$\\max(0,S_1_T-S_2_T)\\; .$$\nNote that there is no real difference between a put and a call:  the exchange option \\index{exchange option} can be viewed as a call on the first asset with random strike $S_2_T$ or as a put on the second asset with random strike $S_1_T$.\n\nAssume the assets pay constant dividend yields $q_i$ and assume the prices satisfy\n$$\\frac{\\d  S_i}{S_i} = \\mu_i\\d   t+\\sigma_i\\d   B_i$$\nwhere each $B_i$ is a Brownian motion under the actual probability measure.  As before, the drifts $\\mu_i$ can be quite general random processes.  We also allow the volatilities $\\sigma_i$ and the correlation $\\rho$ of the Brownian motions to be random processes; however, we make the assumption that $\\sigma$ defined as\n$$\n\\sigma = \\sqrt{\\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2}\n$$ {#eq-margrabesigma}\n\nis a constant.  As shown in @eq-volatilityratio, $\\sigma$ is the volatility of $S_1/S_2$ (and also $S_2/S_1$).  So, the assumption we are making is that the volatility of the ratio of the asset prices is constant.  In @sec-s:volatility, we will relax this assumption to allow $\\sigma$ to be time-varying (though still non-random).  \n\nThe following is the formula of Margrabe [@Margrabe]: \\index{Margrabe's formula}\n\n\n::: Rule\n## \nThe value of a European option to exchange two assets at date $T$  is\n$$\n\\mathrm{e}^{-q_1 T}S_1_0\\mathrm{N}(d_1)-\\mathrm{e}^{-q_2 T}S_2_0\\mathrm{N}(d_2)\\;,\n$$ {#eq-margrabeoption}\n\nwhere \n\n$$\nd_1= \\frac{\\log\\left(\\frac{S_1_0}{S_2_0}\\right)+\\left(q_2-q_1+\n\\frac{1}{2}\\sigma^2\\right)T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-margrabe_d1}\n\n$$\nd_2=d_1-\\sigma\\sqrt{T}\\;,\n$$ {#eq-margrabe_d2}\n\n\n\n:::\n\n\nMargrabe's derivation is a very simple argument based on the Black-Scholes formula.  We noted in @sec-c:foreignexchange that the Black-Scholes formula does not depend on the currency---if the underlying asset and risk-free asset are dollar denominated, the formula gives the dollar value of an option; if they are yen denominated, the formula gives the yen value of an option, etc.  So we can take the currency to be units of the second asset; i.e., we will use the second asset as numeraire.  With this numeraire, the value of the first asset is $S_1/S_2$.  The value of the exchange option at maturity is\n$$\\max(0,S_1_T-S_2_T) = S_2_T\\max\\left(0,\\frac{S_1_T}{S_2_T}-1\\right)\\; .$$\nThis is the value in the natural currency (e.g., dollars).  The value using the second asset as numeraire is obtained by dividing by $S_2_T$, so it is\n$$\\max\\left(0,\\frac{S_1_T}{S_2_T}-1\\right)\\; .$$\nThis is the value of a standard call option, the underlying being the first asset measured in units of the second.  We can apply the Black-Scholes formula to obtain the  value of the option (in units of the second asset) at date $0$.  Multiplying this value by $S_2_0$ will give the option value in the natural currency.\n\nThe risk-free rate when the second asset is the numeraire is the dividend yield on the second asset $q_2$.  To see this, note that the price of the second asset is always equal to one; moreover, an investment in the second asset will accumulate at the rate $q_2$ via reinvestment of dividends.  Therefore, $q_2$ is a risk-free rate of return.\n\nThe dividend yield on the first asset remains $q_1$.  To see this, note that the dividend paid in the natural currency is $q_1S_1_t\\d   t$ in an instant $\\d  t$ and the value of this dividend using the second asset as numeraire is $[q_1S_1_t/S_2_t]\\d   t$, which is the fraction $q_1\\d   t$ of the value $S_1_t/S_2_t$ of the first asset using the second asset as numeraire.  \n\nThe volatility of the first asset using the second as numeraire is the volatility of the ratio $S_1_t/S_2_t$, which is $\\sigma$ defined in @eq-margrabesigma.  Applying the Black-Scholes formula with these inputs yields Margrabe's formula directly.^[Of course, it is possible to give a direct proof, without relying on the Black-Scholes formula.  A sketch is given in @sec-s:margrabecomplete]. \n\nIn terms of programming, we could of course write entirely separate programs for the options discussed so far and those to be discussed in this chapter but it will become clear that they have common structure.  As discussed in the introduction to this chapter, each is the present value of what is received upon exercise multiplied by $\\mathrm{N}(x)$ minus the present value of what is delivered upon exercise multiplied by $\\mathrm{N}(y)$ and $x$ in each case is the logarithm of the ratio of present values plus one-half $\\sigma^2T$, all divided by $\\sigma\\sqrt{T}$.  Thus, we first write a code for a generic option price. Later we use this generic option price function to price other options. \n\n::: {.cell execution_count=2}\n``` {.python .cell-code code-fold=\"true\"}\nimport numpy as np\nfrom scipy.stats import norm\n\ndef generic_option(P1, P2, sigma, T):\n    \"\"\"\n    Inputs:\n    P1 = present value of asset to be received\n    P2 = present value of asset to be delivered\n    sigma = volatility\n    T = time to maturity\n    \"\"\"\n    x = (np.log(P1 / P2) + 0.5 * sigma ** 2 * T) / (sigma * np.sqrt(T))\n    y = x - sigma * np.sqrt(T)\n    N1 = norm.cdf(x)\n    N2 = norm.cdf(y)\n    return P1 * N1 - P2 * N2\n\n\n\n\n# Example usage\nP1 = 100\nP2 = 90\nsigma = 0.2\nT = 1\n\nprint(\"Generic Option:\", generic_option(P1, P2, sigma, T))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nGeneric Option: 13.589108116054796\n```\n:::\n:::\n\n\n Now we can use the following one-line programs to value exchange options.  \n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\ndef margrabe(S1, S2, sigma, q1, q2, T):\n    \"\"\"\n    Inputs:\n    S1 = price of asset to be received\n    S2 = price of asset to be delivered\n    sigma = volatility of ratio of prices\n    q1 = dividend yield of asset to be received\n    q2 = dividend yield of asset to be delivered\n    T = time to maturity\n    \"\"\"\n    P1 = np.exp(-q1 * T) * S1\n    P2 = np.exp(-q2 * T) * S2\n    return generic_option(P1, P2, sigma, T)\n\n# Example usage\nS1 = 100\nS2 = 90\nsigma = 0.2\nq1 = 0.01\nq2 = 0.02\n\nprint(\"Margrabe Option:\", margrabe(S1, S2, sigma, q1, q2, T))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMargrabe Option: 14.05169829758782\n```\n:::\n:::\n\n\nWe could also have calculated the Black-Scholes call formula as \n$$\n\\text{Generic\\_Option}(Exp(-q*T)*S, Exp(-r*T)*K, sigma, T)\n$$\n\nand the Black-Scholes put formula as\n\n$$\n\\text{Generic\\_Option}(Exp(-r*T)*K, Exp(-q*T)*S, sigma, T).\n$$\n\n\n## Black's Formula {#sec-s:black}\nBlack [@Black] gives formulas for the values of options on futures contracts when interest rates are deterministic (i.e., non-random).  It is well known (and we will establish this in @sec-s:futuresforwards) that, when interest rates are deterministic, futures prices should equal forward prices, so Black's formulas also yield formulas for the values of options on forward contracts when interest rates are deterministic.  However, the formulas for options on forwards are valid more generally (even when interest rates vary randomly) and now a mention of Black's formulas is more likely to be referring to the formulas for options on forwards, instead of the formulas for options on futures.  In any case, we will start with  the formulas for options on forwards and then in @sec-s:futuresoptions derive the formulas for options on futures when interest rates are deterministic.\n\nWe consider a forward contract that matures at some date $T'$ and a call or put option on the forward that matures at $T \\leq T'$.  The meaning of a call option on a forward \\index{forward option} is that exercise of the call creates a long position in the forward contract with forward price equal to the strike price of the option.  The long forward contract means that the investor will receive the underlying asset at $T'$ and pay the forward price (the strike of the option) at $T'$.  Thus, the strike price is not paid at the date of exercise but instead is paid when the underlying asset is delivered.  Symmetrically, the exercise of a put creates a short position in the forward contract with forward price equal to the strike of the put, which means that the exerciser must deliver the underlying at $T'$ and will receive the strike price at $T'$.\n\nWe will denote the market forward price by $F_t$.  We assume the forward price satisfies\n$$\n\\frac{\\d  F}{F} = \\mu\\d   t + \\sigma\\d   B\\;,\n$$ {#eq-dforward}\n\nwhere $B$ is a Brownian motion.  As before, $\\mu$ can be a quite general random process.  We will assume in this section that the volatility $\\sigma$ is a constant and generalize to a time-varying (but non-random) volatility in @sec-s:volatility.  In @sec-s:merton, we will discuss the relations of the forward price and its volatility to the price and volatility of the underlying.\n\n\nBlack's formulas are particularly useful when interest rates are assumed to be random, as we will see in Part~\\ref{p_fixedincome} of the book when we study fixed income derivatives.  Therefore, we do not assume here that there is a constant risk-free rate. Instead we will assume that there is a discount bond that pays \\$1 at date $T'$.  It is called a discount bond \\index{discount bond} because its price is the appropriate discount factor for computing the present value of nonrandom cash flows at date $T'$.  Such a bond is also called a zero coupon bond \\index{zero coupon bond} because it does not pay any cash flows until $T'$, when it pays its face value (which we take simply for convenience to be \\$1).   We will let $P(t,T')$ denote the price of the bond at date $t$.^[In this section we could drop the $T'$ in $P(t,T')$ and simply write $P_t$, because we only consider one maturity date, but we will use the same notation when discussing multiple maturities in Part~\\ref{p_fixedincome].}\n\nBlack's formulas are: \\index{Black's formula}\n\n::: Rule\n## \nThe values at date $0$ of European options with strike $K$ and maturity $T$  on a forward contract with maturity $T'$ are\n\n$$\n\\text{Call Price} =P(0,T')F_0\\mathrm{N}(d_1)-P(0,T')K\\mathrm{N}(d_2)\\; ,\n$$ {#eq-black}\n\n$$\n\\text{Put Price} =P(0,T')K\\mathrm{N}(-d_2)-P(0,T')F_0\\mathrm{N}(-d_1)\\; ,\n$$ {#eq-black_put}\n\n$$\n$$\nwhere\n$$\nd_1= \\frac{\\log\\left(\\frac{F_0}{K}\\right)+\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-black_d1}\n\n$$\nd_2=d_1-\\sigma\\sqrt{T}\\;.\n$$ {#eq-black_d2}\n\n\n:::\n\n\nBlack's formulas are a simple consequence of Margrabe's formula.  To see this, we first need to describe the value of an option on a forward at the maturity date $T$ of the option.  Consider a call option.  Exercise of the call results in a long forward position with forward price $K$.  The value of the long forward is given by its market price $F_T$, but we must keep in mind that the forward price is not paid until the underlying is delivered at date $T'$.  So suppose that you exercise the call and then sell a forward contract at the market forward price $F_T$.  The delivery/receipt obligations of the long and short forwards cancel, leaving you with the obligation to pay $K$ dollars at date $T'$ and with an asset of $F_T$ dollars to be received at date $T'$.  The value of the net cash flow at date $T$ is $P(T,T')[F_T-K]$.  This is the value if exercised, so the value of the call at date $T$ is\n$$\n\\max\\big(0, P(T,T')[F_T-K]\\big) = \\max\\big(0,P(T,T')F_T-P(T,T')K\\big)\\;.\n$$ {#eq-blackcallexchange1}\n\nWe can write this as\n$$\n\\max(0,S_1_T-S_2_T)\n$$ {#eq-blackcallexchange2}\n\nif we define\n$$\nS_1_t = P(t,T')F_t \\quad \\text{and} \\quad S_2_t = P(t,T')K\n$$ {#eq-blackexchange}\n\nfor $t=T$ (and more generally for $t \\leq T$).  Thus, the value at maturity of a call option on a forward is the value at maturity of an option to exchange the two assets with prices $S_1$ and $S_2$ (we will establish in a moment that $S_1$ and $S_2$ are actually asset prices).  It follows that the value at date $0$ of a call option on a forward is the value at date $0$ of an option to exchange the two assets.\n\nNow consider a put option on a forward.  Exercising the put and unwinding the short forward position by buying a forward at the market price $F_T$ will leave one with a net cash flow of $K-F_T$ to be received at the maturity date $T'$ of the forward.  Therefore the value of the put at maturity is\n$$\n\\max(0,P(T,T')[K-F_T]) = \\max(S_2_T-S_1_T)\\;.\n$$ {#eq-blackputexchange}\n\nTherefore, the value at date $0$ of the put option on a forward must be the value at date $0$ of an exchange option, where asset one in @eq-blackexchange is exchanged for asset two.\n\nThe key assumption in deriving Margrabe's formula is that the volatility of the ratio of asset prices is a constant.  For a call option on a forward, the relevant ratio is $S_1/S_2 = F/K$.  Because $K$ is a constant, the volatility of the ratio is the volatility $\\sigma$ of the forward price $F$, which we have assumed to be constant.  For a put option on a forward, the relevant ratio is $S_2/S_1 = K/F$.  Ito's formula implies\n\n\\begin{align*}\n\\frac{d(K/F)}{K/F} &= -\\frac{\\d  F}{F} + \\left(\\frac{\\d  F}{F}\\right)^2\\; ,\\\\\n&= (-\\mu +\\sigma^2)\\d   t - \\sigma\\d   B\\\\\n&= (-\\mu+\\sigma^2)\\d   t + \\sigma (-\\d  B),\n\\end{align*}\nThe purpose of the last equality displayed here is to emphasize that we should take the volatility of $K/F$ to be the positive number $\\sigma$.  We can do this by using $-B$ as the Brownian motion instead of $B$.^[This is really nothing more than the usual convention of defining the standard deviation of a random variable to be the positive square root of the variance.] Thus, we can apply Margrabe's formula to value calls and puts on forwards (once we verify that $S_1$ and $S_2$ are indeed asset prices).  \n\nTo obtain Black's @eq-black for a call on a forward from Margrabe's @eq-margrabeoption, we simply substitute $S_1_0=P(0,T')F_0$, $S_2_0=P(0,T')K$, $q_1=0$ and $q_2=0$ in Margrabe's formula.   A put option is the reverse exchange, so Margrabe's formula gives\n$$\nP(0,T')K\\mathrm{N}(d^m_1) - P(0,T')F_0\\mathrm{N}(d^m_2)\\;,\n$$ {#eq-margrabeput}\n\nwhere\n\\begin{align*}\nd^m_1&= \\frac{\\log\\left(\\frac{P(0,T')K}{P(0,T')F_0}\\right)+\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\; ,\\\\\nd^m_2 &=d^m_1-\\sigma\\sqrt{T}.\n\\end{align*}\nWe introduce the superscript $m$ here to distinguish these numbers in Margrabe's formula from the $d_1$ and $d_2$ defined in @eq-black_d1 and @eq-black_d2.  Notice that\n\\begin{align*}\nd^m_1& = -\\frac{\\log\\left(\\frac{F_0}{K}\\right)-\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}} = -d_2\\\\\nd^m_2 &= -\\frac{\\log\\left(\\frac{F_0}{K}\\right)+\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}} =-d_1,\n\\end{align*}\nso Margrabe's @eq-margrabeput is the same as Black's @eq-black_put for a put option on a forward.\n\nWe still need to explain why $S_1$ and $S_2$ defined in @eq-blackexchange are asset prices, in fact the prices of dividend-reinvested assets since we have taken $q_1=q_2=0$ in applying Margrabe's formula.  The case of $S_2$ should be clear: it is the price of $K$ units of the discount bond maturing at $T'$.  The case of $S_1$ is more subtle.  It is the price of the following portfolio constructed at date $0$ and held until date $T$: go long one forward contract and buy $F_0$ units of the discount bond maturing at $T'$.  The value at date $t$ of the bonds in the portfolio is $F_0P(t,T')$.  The value at date $t$ of the long forward contract can be seen by considering unwinding it by selling a forward at date $t$ at the market price $F_t$.  This cancels the delivery/receipt obligations on the underlying and results in a net cash flow of $F_t-F_0$ to be received at date $T'$.  The value at date $t$ of this future cash flow is $P(t,T')[F_t-F_0]$ and when we add this to the value of the bonds we obtain $P(t,T')F_t = S_1_t$.\n\nPut-call parity \\index{put-call parity} for options on forwards is\n$$\\text{Call Price}  + P(0,T')K = \\text{Put Price}  + P(0,T')F_0\\; .$$\nThe left-hand side is the cost of the call and $K$ units of the discount bond, which have value $\\max(F_T,K)P(T,T')$ at time $T$.  The right-hand side is the cost of the put option and $F_0$ units of the discount bond, which, together with a long forward contract initiated at date $0$, also have value $\\max(F_T,K)P(T,T')$ at time $T$.\n\nAs in the case of exchange option, we can also write one-line programs for pricing options on futures and forwards.\n\n::: {.cell execution_count=4}\n``` {.python .cell-code code-fold=\"true\"}\ndef black_call(F, K, P, sigma, T):\n    \"\"\"\n    Inputs:\n    F = forward price\n    K = strike price\n    P = price of discount bond maturing when forward matures\n    sigma = volatility of forward price\n    T = time to maturity\n\n    To value a futures option, input F = futures price and P = price\n    of discount bond maturing when option matures.\n    \"\"\"\n    return generic_option(P * F, P * K, sigma, T)\n\ndef black_put(F, K, P, sigma, T):\n    \"\"\"\n    Inputs:\n    F = forward price\n    K = strike price\n    P = price of discount bond maturing when forward matures\n    sigma = volatility of forward price\n    T = time to maturity\n\n    To value a futures option, input F = futures price and P = price\n    of discount bond maturing when option matures.\n    \"\"\"\n    return generic_option(P * K, P * F, sigma, T)\n\n\nF = 100\nK = 90\nP = 0.95\nsigma = 0.2\n\nprint(\"Black Call:\", black_call(F, K, P, sigma, T))\nprint(\"Black Put:\", black_put(F, K, P, sigma, T))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nBlack Call: 12.909652710252054\nBlack Put: 3.409652710252054\n```\n:::\n:::\n\n\n## Merton's Formula {#sec-s:merton}\nNow we reconsider the Black-Scholes model but without assuming there is a constant risk-free rate.  We assume instead that there is a discount bond maturing at the same date as the option.  Letting $T$ denote the maturity date of the option and discount bond, we write the price of the discount bond at dates $t \\leq T$ as $P(t,T)$.  We continue to assume that the stock has a constant dividend yield $q$ but we make a different assumption about volatility---instead of assuming that the volatility of the stock is constant, we assume that the volatility of its forward price is constant.  We relax this to allow time-varying but non-random volatility of the forward price in @sec-s:volatility.\n\nThe forward contract we consider is a forward contract for the stock maturing at the date $T$ that the option matures.  Let $F_t$ denote the forward price for this contract at dates $0 \\leq t\\leq T$.  Because the forward price must equal the spot price at the maturity of a forward contract, we have $F_T=S_T$.  Consider a call option on the forward, with the call maturing at $T$ also.  In the notation of the previous section, we have $T'=T$ and hence $P(T,T')=1$ (the discount bond is worth \\$1 at maturity).  Therefore the value @eq-blackcallexchange1 of the call on the forward at its maturity $T$ is\n$$\\max(0,F_T-K) = \\max(0,S_T-K)\\; ,$$\nwhich is the same as the value of the call on the stock.  Therefore, the value at date $0$ of the call on the stock must equal the value at date $0$ of the call on the forward, and we can use Black's @eq-black for a call option on a forward to price a call option on the stock, assuming the forward price has a constant volatility. \n\nLikewise, the value at the maturity date $T$ of a put option on the same forward contract is, from @eq-blackputexchange,\n$$\\max(0,K-F_T) = \\max(0,K-S_T)\\; .$$\nHence, we can use Black's @eq-black_put to price a put option on the stock, assuming the forward price has a constant volatility.\n\nIt is not necessary that the forward contract be traded, because we can create a synthetic forward using the stock.  To create a synthetic forward at date $t$ we buy $\\mathrm{e}^{-q(T-t)}$ shares of the stock at cost $\\mathrm{e}^{-q(T-t)}S_t$.  With reinvestment of dividends, this will accumulate to one share at date $T$.  We finance the purchase of the stock by shorting $\\mathrm{e}^{-q(T-t)}S_t/P(t,T)$ units of the discount bond.  This results in a liability of $\\mathrm{e}^{-q(T-t)}S_t/P(t,T)$ dollars at date $T$, so the forward purchase is arranged by promising to pay $\\mathrm{e}^{-q(T-t)}S_t/P(t,T)$ dollars at the delivery date; i.e., the forward price is^[If there is a constant risk-free rate $r$, then it must be that $P(t,T) = \\mathrm{e}^{-r(T-t)}$, so  @eq-forwardprice becomes \n$$F_t = \\mathrm{e}^{(r-q)(T-t)}S_t\\; ,$$\nwhich is the same as the covered interest parity condition @eq-forwardexchangerate---recall that we interpret the exchange rate as the price of an asset with dividend yield $q=r_f$.}\n$$\nF_t = \\frac{\\mathrm{e}^{-q(T-t)}S_t}{P(t,T)}\\;.\n$$ {#eq-forwardprice}\n\nThe assumption we need to apply Black's formulas is that\n$$\n\\frac{\\d  F}{F} = \\mu\\d   t+\\sigma\\d   B\\;,\n$$ {#eq-mertonforward}\n\nwhere $B$ is a Brownian motion, $\\mu$ can be a quite general random process, and $\\sigma$ is a constant. At the end of this section, we will discuss the meaning of this assumption in terms of the volatilities of the stock and bond and their correlation.\n\nUnder this assumption, the following formulas originally due to Merton [@Merton] follow immediately from Black's formulas @eq-black - @eq-black_d2  by substituting $F_0 = \\mathrm{e}^{-qT}S_0/P(0,T)$.\n\n::: Rule\n## \nAssuming the forward price has a constant volatility $\\sigma$, the values at date $0$ of European calls and puts maturing at date $T$ on a stock with a constant dividend yield $q$ are\n\n$$\n\\text{Call Price}  = \\mathrm{e}^{-q T}S_0\\mathrm{N}(d_1)-P(0,T)K\\mathrm{N}(d_2)\\;,\n$$ {#eq-mertoncall}\n\n$$\n\\text{Put Price} = P(0,T)K\\mathrm{N}(-d_2) - \\mathrm{e}^{-qT}S_0\\mathrm{N}(-d_1)\\;,\n$$ {#eq-mertonput}\n\nwhere\n$$\nd_1= \\frac{\\log\\left(\\frac{S_0}{KP(0,T)}\\right)-qT+\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-merton_d1}\n\n$$\nd_2=d_1-\\sigma\\sqrt{T}\\;.\n$$ {#eq-merton_d2}\n\n\n\n:::\n \\index{Merton's formula}\n\n\n\nThese formulas are clearly similar to the Black-Scholes formulas.  The similarities are made more apparent by writing the discount bond price in terms of its yield.  The yield $y$ of the discount bond is defined as \\index{discount bond yield}\n$$y = \\frac{-\\log P(0,T)}{T} \\qquad\\Longleftrightarrow \\qquad P(0,T) = \\mathrm{e}^{-yT}\\; .\n$$\nSubstituting this into the expressions above, we have:\n\n::: Rule\n## \nAssuming the forward price has a constant volatility $\\sigma$, the values at date $0$ of European calls and puts maturing at date $T$ on a stock with a constant dividend yield $q$ are\n\n$$\n\\text{Call Price} =\\mathrm{e}^{-q T}S_0\\mathrm{N}(d_1)-\\mathrm{e}^{-yT}K\\mathrm{N}(d_2)\\;,\n$$ {#eq-merton}\n\n$$\n\\text{Put Price} =\\mathrm{e}^{-yT}K\\mathrm{N}(-d_2)-\\mathrm{e}^{-q T}S_0\\mathrm{N}(-d_1), \n$$ {#eq-merton2}\n\n$$\nd_1 = \\frac{\\log\\left(\\frac{S_0}{K}\\right)+\\left(y-q+\\frac{1}{2}\\sigma^2\\right)T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-merton_d1again}\n\n$$\nd_2 = d_1 - \\sigma\\sqrt{T}\\;.\n$$ {#eq-merton_d2again}\n\n\n\n:::\n\nThis shows that the Merton call and put formulas can be calculated from the Black-Scholes call and put functions given in @sec-c:blackscholes by inputting the yield of the discount bond as the risk-free rate and by inputting the volatility of the forward price as $\\sigma$.\n\nIf one wants to assume that there is a constant risk-free rate, then the discount bond price will have to be $\\mathrm{e}^{-rT}$ and its yield will be the risk-free rate $r$.  In this case, the forward price is $\\mathrm{e}^{(r-q)T}S_0$ and it has the same volatility as $S$.  Making these substitutions, the Merton formulas @eq-merton - @eq-merton_d2again are the same as the Black-Scholes formulas.  However, the Merton formulas are an important generalization.  It is common practice to use the yield of the discount bond as the risk-free rate that is input into the Black-Scholes formulas.  The Merton formulas justify this practice.  It is less common to attempt to estimate the volatility of the forward price and use this (as one should since the risk-free rate really is not constant) as the volatility in the Black-Scholes-Merton formulas.  However, this does little damage for pricing short-term options, because the volatility of the forward price---see @eq-mertonsigma below---will be approximately the same as the volatility of the underlying for short-term options, due to the low volatility of short-term bond prices.  Moreover, when one computes an implied volatility from the Black-Scholes formula (using the discount bond yield as the risk-free rate),  it should be regarded as the market's view of the forward price volatility, and it is perfectly appropriate to input it into the Black-Scholes-Merton formulas to price another option (assuming of course that the forward price volatility can be regarded as constant).\n\nThe volatility of the forward price can be computed in terms of the  volatilities and correlation of the stock and discount bond as follows.  Assume that \\index{forward price volatility}\n\n\\begin{align*}\n\\frac{\\d  S}{S}& = \\mu_s\\d   t + \\sigma_s\\d   B_s\\; ,\\\\\n\\frac{\\d  P}{P}& = \\mu_p\\d   t + \\sigma_p\\d   B_p,\n\\end{align*}\nwhere $B_s$ and $B_p$ are Brownian motions with correlation $\\rho$.  Then  @eq-volatilityproduct and @eq-volatilityratio show that the volatility of $F_t = \\mathrm{e}^{-q(T-t)}S_t/P(t,T)$ is $\\sigma$ defined as \n$$\n\\sigma = \\sqrt{\\sigma_s^2+\\sigma_p^2 - 2\\rho\\sigma_s\\sigma_p}\\;.\n$$ {#eq-mertonsigma}\n\nAs mentioned before, we will consider in @sec-s:volatility that the the volatility @eq-mertonsigma may vary over time in a non-random way.\n\n## Deferred Exchange Options\n\nA call option on a forward can be viewed as an option to exchange $K$ dollars (or, equivalently, $K$ units of the discount bond maturing at the maturity date of the forward) for the underlying asset, with the exchange taking place at the maturity date of the forward.  Therefore, it is an exchange option in which the exchange takes place at a fixed date after the option matures.  We can easily extend Margrabe's formula to value options to exchange other assets when the option maturity precedes the date of the exchange. \\index{deferred exchange option}\n\nAs in @sec-s:margrabe, consider two assets with prices $S_i$ and constant dividend yields $q_i$ and assume the prices satisfy\n$$\\frac{\\d  S_i}{S_i} = \\mu_i\\d   t + \\sigma_i\\d   B_i\\; ,$$\nwhere the drifts $\\mu_i$, the volatilities $\\sigma_i$ and the correlation $\\rho$ of the two Brownian motions can be general random processes.  However, also as in @sec-s:margrabe, assume that the volatility\n$$\\sigma = \\sqrt{\\sigma_1^2 + \\sigma_2^2 - 2\\rho\\sigma_1\\sigma_2}$$\nof the ratio of asset prices is constant.  \n\nConsider an option maturing at date $T$ to exchange the second asset for the first asset at date $T'\\geq T$.  To understand the value of the option at date $T$, suppose it is exercised.  To unwind the positions in the two assets, one can sell a forward contract on the asset to be received and buy a forward contract on the asset to be delivered, with the forward contracts maturing at the date of the exchange.  Then the difference $F_1_T-F_2_T$ in the forward prices is a cash flow to be received/paid at the exchange date $T'$ and its value at date $T$ is $P(T,T')[F_1_T-F_2_T]$.  Therefore, the value of the option at its maturity $T$ is\n$$\\max(0,P(T,T')F_1_T - P(T,T')F_2_T)\\; .$$\nAs in @sec-s:black, this valuation does not require the existence of traded forward contracts, because synthetic forwards can be created.  Also as in @sec-s:black we know that\n$$S^*_1_t = P(t,T')F_1_t \\quad \\text{and} \\quad S^*_2_t = P(t,T')F_2_t$$\nare the prices of dividend-reinvested assets.  Therefore, the option to exchange the assets at date $T'$ must have the same value as an option to exchange at date $T$ the assets with prices $S^*_i$.  \n\nWe recall here the arbitrage @eq-forwardprice for the forward prices (making the change that here the forwards mature at $T'$):\n$$F_i_t =  \\frac{\\mathrm{e}^{-q_i(T'-t)}S_i_t}{P(t,T')}\\; .$$\nThus,\n$$S^*_i_t = \\mathrm{e}^{-q_i(T'-t)}S_i_t\\; .$$\nThis implies that the volatility of the ratio $S_1^*/S_2^*$ is the same as the volatility of the ratio $S_1/S_2$.  Therefore, we can price a deferred exchange option from Margrabe's formula, inputting the prices $S^*_i_0 = \\mathrm{e}^{-q_iT'}S_i_0$ as the initial asset prices and zero as their dividend yields.  This formula is:\n\n::: Rule\n## \nThe value of a European option maturing at date $T$ to exchange two assets at date $T'$ is\n$$\n\\mathrm{e}^{-q_1 T'}S_1_0\\mathrm{N}(d_1)-\\mathrm{e}^{-q_2 T'}S_2_0\\mathrm{N}(d_2)\\;,\n$$ {#eq-margrabedeferredoption}\n\nwhere \n\n$$\nd_1= \\frac{\\log\\left(\\frac{S_1_0}{S_2_0}\\right)+(q_2-q_1)T'+\n\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-margrabedeferred_d1}\n\n$$\nd_2=d_1-\\sigma\\sqrt{T}\\;,\n$$ {#eq-margrabedeferred_d2}\n\n\n\n:::\n\n::: {.cell execution_count=5}\n``` {.python .cell-code code-fold=\"true\"}\ndef margrabe_deferred(S1, S2, sigma, q1, q2, Tmat, Texch):\n    \"\"\"\n    Inputs:\n    S1 = price of asset to be received\n    S2 = price of asset to be delivered\n    sigma = volatility of ratio of prices\n    q1 = dividend yield of asset to be received\n    q2 = dividend yield of asset to be delivered\n    Tmat = time to maturity of option\n    Texch = time until exchange >= TOption\n    \"\"\"\n    P1 = np.exp(-q1 * Texch) * S1\n    P2 = np.exp(-q2 * Texch) * S2\n    return generic_option(P1, P2, sigma, Tmat)\n\n# Example usage\nS1 = 100\nS2 = 90\nq1 = 0.01\nq2 = 0.02\nsigma=0.2\nTmat = 1\nTexch = 2\n\nprint(\"Margrabe Deferred:\", margrabe_deferred(S1, S2, sigma, q1, q2, Tmat, Texch))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMargrabe Deferred: 14.513318533107103\n```\n:::\n:::\n\n\n## Greeks and Hedging {#sec-s:forwardhedging}\n\nThe Greeks for the Margrabe and Black formulas can be calculated in the same way that we calculated them in @sec-c:blackscholes for the Black-Scholes formula.  In analogy with @eq-greeksimplify, it can be shown for the Margrabe formula that\n$$\\mathrm{e}^{-q_1T}S_1_0\\mathrm{n}d(d_1) = \\mathrm{e}^{-q_2T}S_2_0\\mathrm{n}d(d_2)\\; ,$$\nand again this simplifies the calculations.  This equation applies to the Black call formula by taking $q_1=q_2=0$, $S_1_0=P(0,T')F_0$, and $S_2_0=P(0,T')K$, leading to\n$$F_0\\mathrm{n}d(d_1) = K\\mathrm{n}d(d_2)\\; .$$\nThe Greeks for the Black call formula and the Margrabe formula are: \\index{Greeks}\n\n\n::: Rule\n## \n\n\\begin{align*}\n&**Black Call** && **Margrabe**\\\\\n& & & \\\\\n\\frac{\\partial}{\\partial F} &= P(0,T')\\mathrm{N}(d_1)  % Black delta1\n&\\frac{\\partial}{\\partial S_1}&= \\mathrm{e}^{-q_1T}\\mathrm{N}(d_1)\\\\ % Margrabe delta1\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\\frac{\\partial}{\\partial P} &= F_0\\mathrm{N}(d_1)-K\\mathrm{N}(d_2)% Black delta2\n&\\frac{\\partial}{\\partial S_2}&=-\\mathrm{e}^{-q_2T}\\mathrm{N}(d_2)\\\\ % Margrabe delta2\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\\frac{\\partial^2}{\\partial F^2} &= \\frac{P(0,T')\\mathrm{n}d(d_1)}{\\sigma\\sqrt{T}F_0}  % Black gamma1\n&\\frac{\\partial^2}{\\partial S_1^2}&= \\frac{\\mathrm{e}^{-q_1T}\\mathrm{n}d(d_1)}{\\sigma\\sqrt{T}S_1_0}\\\\ % Margrabe gamma1\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\\frac{\\partial^2}{\\partial P^2} &= 0 % Black gamma2\n&\\frac{\\partial^2}{\\partial S_2^2}&=\\frac{\\mathrm{e}^{-q_2T}\\mathrm{n}d(d_2)}{\\sigma\\sqrt{T}S_2_0}\\\\ %Margrabe gamma2\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\\frac{\\partial^2}{\\partial F \\partial P} &= \\mathrm{N}(d_1)&\\frac{\\partial^2}{\\partial S_1 \\partial S_2}% Black crossgamma\n&= -\\frac{\\mathrm{e}^{-q_1T}\\mathrm{n}d(d_1)}{\\sigma\\sqrt{T}S_2_0}\\\\ % Margrabe crossgamma\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n-\\frac{\\partial}{\\partial T} &= -\\frac{\\sigma P(0,T')F_0\\mathrm{n}d(d_1)}{2\\sqrt{T}}%Black theta part1\n& -\\frac{\\partial}{\\partial T}&=q_1\\mathrm{e}^{-q_1T}S_1_0\\mathrm{N}(d_1)\\\\ %Margrabe theta part1\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n& &&-q_2\\mathrm{e}^{-q_2T}S_2_0\\mathrm{N}(d_2)\\\\ % Margrabe theta part2\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n&&&-\\frac{\\sigma \\mathrm{e}^{-q_1T}S_1_0\\mathrm{n}d(d_1)}{2\\sqrt{T}}\\\\ % Margrabe theta part3\n%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\\frac{\\partial}{\\partial \\sigma} &= \\sqrt{T}P(0,T')F_0\\mathrm{n}d(d_1) % Black vega\n&\\frac{\\partial}{\\partial \\sigma}&=\\sqrt{T}\\mathrm{e}^{-q_1T}S_1_0\\mathrm{n}d(d_1) % Margrabe vega\n\\end{align*}\n\n:::\n\n\n\nHedging for the Margrabe formula is much the same as for the Black-Scholes formula.  We would delta-hedge a \\index{delta hedge} written exchange option by holding $\\delta_1=\\mathrm{e}^{-q_1T}\\mathrm{N}(d_1)$ shares of the first asset and $\\delta_2 =- \\mathrm{e}^{-q_2T}\\mathrm{N}(d_2)$ shares of the second asset (which means shorting the second asset).  This position would be financed by borrowing at the risk-free rate (or shorting the discount bond).  The same argument that we used in @sec-s:deltahedging shows that this zero-cost portfolio will have a zero return if continuously rebalanced.\n\nBecause the Black formulas are a special case of the Margrabe formula, we can delta-hedge options on forwards in the same way.  Putting $q_1=q_2=0$, $S_1_0=P(0,T')F_0$ and $S_2_0=P(0,T')K$, we would delta-hedge a written call option by buying $\\mathrm{N}(d_1)$ shares of the first asset and shorting $\\mathrm{N}(d_2)$ shares of the second, where $d_1$ and $d_2$ are defined in the Margrabe formulas @eq-margrabe_d1 and @eq-margrabe_d2 and equivalently in the Black formulas @eq-black_d1 and @eq-black_d2.  This position would be financed by shorting the discount bond to raise the difference between the cost of the portfolio and the option value so that the cost of the total portfolio (including the short discount bond) equals the option value.  However, the first asset here consists of a long forward contract plus $F_0$ units of the discount bond, and the second asset is $K$ units of the discount bond.  Furthermore, we are using the discount bond to finance the position (including the buying and shorting of the discount bond!).  We can conclude that buying $\\mathrm{N}(d_1)$ units of the first asset means that we should buy $\\mathrm{N}(d_1)$ forward contracts.  This has zero cost.  Therefore, the portfolio value will equal the value of the discount bonds, and this must equal the option value.  So, we actually invest the option value  \n$$P(0,T')F_0\\mathrm{N}(d_1) - P(0,T')K\\mathrm{N}(d_2)\\; ,$$\nin the discount bond, which means buying $F_0\\mathrm{N}(d_1)-K\\mathrm{N}(d_2)$ units of the bond.\n\nA more direct analysis of hedging options on forwards is possible and instructive.  We will consider that topic further in @sec-s:hedgingforwards.\n\n\n\n\n## The Relation of Futures Prices to Forward Prices {#sec-s:futuresforwards}\n\nThe difference between futures and forward contracts is that futures are marked to market, which means that daily gains and losses are posted to the investor's margin account.  Thus, there are interim cash flows on a futures contract, whereas the only cash flows on a forward contract are at the maturity of the forward.  We will establish three useful facts in this section, the last of which follows from the first two: \n\n\n\n\n\\renewcommand{\\labelenumi}{(\\arabic{enumi})}\n1. Futures prices are martingales under the risk-neutral probability. \n2. Forward prices are martingales when we use the discount bond with the same maturity as the forward as the numeraire.\n3. When interest rates are non-random, futures prices equal forward prices.\n\n\n\n\nWe consider the idealized case in which the futures contract is continuously marked to market.  Assume there is an instantaneously risk-free asset with rate of return $r$, which could vary randomly over time, and define, as in @sec-c:arbitrage,\n$$R_t = \\exp\\left(\\int_0^t r_s\\,ds\\right)\\; ,$$\nwhich is the value at date $t$ of a \\$1 investment in the asset at date $0$, with interest continuously reinvested.\nLet $T'$ denote the maturity of the futures contract, and let $F^*_t$ denote the futures price at dates $t \\leq T'$ (the $^*$ notation is to distinguish the futures price from the forward price $F$).\nConsider the portfolio strategy that starts with zero dollars and one long futures contract at price $F^*_0$ and which continuously invests and withdraws from the risk-free asset the gains and losses on the futures contract.  Let $V_t$ denote the value of this portfolio at date $t$.  The change in the value of the portfolio at any instant is the interest earned (or paid, if $V<0$) on the risk-free asset plus the gain/loss on the futures.  This means that\n$$\\d  V = rV\\d   t + \\d  F^*\\; .$$\nBecause all gains and losses on this portfolio are reinvested, $V$ is the price of a dividend-reinvested asset.  Therefore, under the risk-neutral probability (i.e., using $R$ as the numeraire), the ratio $V/R$ must be a martingale and hence have zero drift.  From Ito's formula,\n\\begin{align*}\n\\frac{\\d  (V/R)}{V/R} &= \\frac{\\d  V}{V} - \\frac{\\d  R}{R}\\\\\n&=\\frac{rV\\d   t + \\d  F^*}{V} - r\\d   t\\\\\n&= \\frac{\\d  F^*}{V}\\;.\n\\end{align*}\nThus, the drift of $V/R$ being zero implies the drift of $F^*$ is zero.  We need to assume (and can assume) that $F^*$ is an Ito process with finite expected quadratic variation---cf. condition @eq-regularity1---in which case the absence\nof a drift implies that it is a martingale.  \n\nNow we turn to fact (2).  Consider a forward contract with maturity $T'$ and a discount bond also maturing at $T'$.  Let $F_t$ denote the forward price and let $P(t,T')$ denote the price of the discount bond at dates $t \\leq T'$.  We observed in @sec-s:black that there is a dividend-reinvested asset with price $P(t,T')F_t$.  When we use the discount bond as the numeraire, the ratio $P(t,T')F_t/P(t,T') = F_t$ must be a martingale, which is fact (2).  Because of this fact, a probability measure  corresponding to a discount bond being the numeraire is called a forward measure. \\index{forward measure}\n\nSuppose now that interest rates are deterministic, that is, even if $r$ varies over time, it does so in a non-random way.  Then the discount bond price at date $0$ must be the discount factor\n$$P(0,T') = \\exp\\left(-\\int_0^{T'} r_t\\d   t\\right)\\; .$$\n@eq-probSnumeraire gives the probability of any event $A$ when the discount bond is used as the numeraire as\n$$\\text{prob}^P[A] = \\\\E\\left[1_A\\phi_{T'}\\frac{P(T',T')}{P(0,T')}\\right] = \\exp\\left(-\\int_0^{T'} r_t\\d   t\\right)\\\\E[1_A\\phi_{T'}]\\; ,$$\nwhere $\\phi$ denotes the state prices.\nOn the other hand, the same equation gives the probability of $A$ when $R$ is used as the numeraire as\n$$\\text{prob}^R[A] = \\\\E\\left[1_A\\phi_{T'}\\frac{R_{T'}}{R_0}\\right] = \\exp\\left(-\\int_0^{T'} r_t\\d   t\\right)\\\\E[1_A\\phi_{T'}]\\; .$$\nTherefore, the two probability measures are the same, and consequently the expectations $\\\\E^P$ and $\\\\E^R$ are the same.  Now using the fact that both the futures price and the forward price must equal the spot price at maturity, we have $F^*_{T'} = F_{T'}$, and, from the martingale properties,\n$$F^*_t = \\\\E_t^P[F^*_{T'}] = \\\\E_t^P[F_{T'}] = \\\\E_t^R[F_{T'}] = F_t\\; ,$$\nwhich is fact (3).\n\n\n\n## Futures Options {#sec-s:futuresoptions}\n\nNow we consider options on futures contracts, \\index{futures option} assuming that interest rates are deterministic.  We just showed that in this circumstance the futures price will equal the forward price for a contract of the same maturity.  However, the values of options on a futures contract do not equal the values of options on the corresponding forward contract.  \n\nThe difference is due to marking to market.  Consider futures and forward contracts with maturity $T'$ and options maturing at $T \\leq T'$.  Exercise of a call option on a futures contract will roll the investor into a long futures contract with futures price equal to the market futures price at that date.  The difference $F^*_T-K$ between the market futures price and the strike price of the option is immediately credited to the investor's margin account.  On the other hand, exercise of an option on a forward and sale of the forward results in a cash flow of $F_T - K$ that is received at the maturity date $T'$ of the forward.  Therefore, the value at maturity of a call option on a futures contract is\n$\\max(0,F^*_T-K)$, whereas, as noted before, the value of a call option on a forward at the maturity of the option is $P(T,T')\\max(0,F_T-K)$\n\nAs in the analysis of options on forwards, an options on a futures contract can be viewed as an exchange option, where one exchanges the asset with price\n$S_2_t = P(t,T)K$ at date $t\\leq T$ for the asset with price $S_1_t = P(t,T)F^*_t$.  The asset with price $S_2$ is of course $K$ units of the discount bond maturing at $T$.  Assuming interest rates are deterministic, we have $F^*_t = F_t$, and we noted in @sec-s:black that $P(t,T)F_t$ is the price of a dividend-reinvested asset.  Thus, we can apply Margrabe's formula to price call (and put) options on futures when interest rates are deterministic.  Compared to options on forwards, the difference is that the discount bonds defining the prices $S_1$ and $S_2$ mature at the maturity date of the option rather than at the maturity date of the futures or forward contract.  The result is:\n\n::: Rule\n## \nWhen interest rates are deterministic and the futures price $F^*$ has a constant volatility $\\sigma$, the values of  European calls and puts on a futures contract are\n\n$$\n\\text{Call Price} =P(0,T)F^*_0\\mathrm{N}(d_1)-P(0,T)K\\mathrm{N}(d_2)\\; ,\n$$ {#eq-black2}\n\n$$\n\\text{Put Price} =P(0,T)K\\mathrm{N}(-d_2)-P(0,T)F^*_0\\mathrm{N}(-d_1)\\; ,\n$$ {#eq-black_put2}\n\n$$\n$$\nwhere\n$$\nd_1= \\frac{\\log\\left(\\frac{F^*_0}{K}\\right)+\\frac{1}{2}\\sigma^2T}{\\sigma\\sqrt{T}}\\;,\n$$ {#eq-black_d12}\n\n$$\nd_2=d_1-\\sigma\\sqrt{T}\\;.\n$$ {#eq-black_d22}\n\n\n\n:::\n\nWe can calculate these values from the `Black_Call` and `Black_Put` functions by inputting the price of the discount bond maturing when the option matures rather than the price of the discount bond maturing when the forward/futures matures.  \nWe will derive delta hedges for futures options in  @sec-s:hedgingforwards.\n\n\n\n\n\n\n## Time-Varying Volatility {#sec-s:volatility}\n\nAll of the option pricing formulas in this chapter were derived from Margrabe's formula, the main assumption of which is that the logarithm of the ratio of asset prices at date $T$ is normally distributed with variance equal to $\\sigma^2T$.  As in @sec-s:timevaryingvolatility regarding the Black-Scholes formulas, the formulas in this chapter can easily be adapted to allow a time-varying but non-random volatility.  If the volatility is a non-random function $\\sigma_t$ of time, then we define $\\sigma_{\\text{avg}}$ to be the number such that\n$$\n\\sigma_{\\text{avg}}^2 = \\frac{1}{T}\\int_0^T \\sigma^2_t\\d   t\\;.\n$$ {#eq-averagesigma}\n \nWe should input $\\sigma_{\\text{avg}}$ as (i) the volatility of the ratio of asset prices in Margrabe's formula and the deferred exchange option formula if $\\sigma_t$ is the volatility of the ratio at date $t$ or as (ii) the volatility of the forward price in Black's and Merton's formulas if $\\sigma_t$ is the volatility of the forward price at date $t$.\n\nAs in @sec-s:timevaryingvolatility, equation~@eq-averagesigma enables one to interpret and apply different implied volatilities computed at different maturities.  \\index{term structure of volatility} Another circumstance in which it can be useful is in conjunction with bond price models such as the Vasicek and extended Vasicek models described in @sec-c:vasicek that imply a time-varying non-random volatility for discount bond prices.^[The volatility of a discount bond price cannot be constant because it must go to zero as the bond approaches maturity.]  If we assume a constant volatility for the price of the underlying and a constant correlation between the underlying and the discount bond, then we will have a time-varying non-random  forward price volatility via  @eq-mertonsigma, and we should input the average volatility $\\sigma_{\\text{avg}}$ defined in @eq-averagesigma for the forward price volatility in Black's and Merton's formulas.  As mentioned in @sec-s:merton, this will be more important for long-term options than for short-term options.\n\n## Hedging with Forwards and Futures {#sec-s:hedgingforwards}\n\nIn @sec-c:foreignexchange, we considered hedging quanto contracts with currency forwards.  In @sec-s:forwardhedging, we considered hedging options on forwards with forwards.  To present a more complete analysis of these topics, we need to discuss the gains and losses that accrue from trading forwards.\n\nConsider dates $t<u$ and a forward contract with maturity $T$.  Suppose we purchase $x_t$ forwards at date $t$ and then change our position in forwards to $x(u)$ at time $u$.    The purchase/sale of $x(u)-x_t$ new contracts does not affect the portfolio value, so the change in the value of the portfolio is the change in the value of the $x_t$ contracts purchased at date $t$.  These contracts were worth zero at date $t$, because forward contracts have zero value at initiation.  Selling them at date $u$ cancels the obligation to deliver/receive the underlying, leaving one with a cash flow of $x_t[F(u)-F_t]$ dollars to be received at date $T$.  The value of this cash flow at date $u$ is $x_tP(u,T)[F(u)-F_t]$.  We can write this as\n\\begin{align*}\nx_tP(u,T)[F(u)-F_t]  &= x_t\\big[P(t,T)[F(u)-F_t] + [P(u,T)-P(t,T)][F(u)-F_t]\\big]\\\\\n&= x_t\\big[P(t,T)\\,\\Delta F + (\\Delta P)(\\Delta F)\\big]\\;.\n\\end{align*}\nThis motivates the following definition:\n\n::: Rule\n## \n\nThe change in the value of a portfolio of forward contracts at date $t$ is\n$$\nx_t\\big[P(t,T)\\d   F_t + \\d  P(t,T)\\times \\d  F_t]\\;,\n$$ {#eq-changeforwardvalue}\n\nwhere $x_t$ denotes the number of forward contracts held, $F_t$ denotes the forward price, $P(t,T)$ denotes the price of a discount bond maturing at $T$, and $T$ is the maturity of the forward contract.\n:::\n\n\n\nHedging with futures is a bit simpler, because the gains and losses are received instantaneously (daily, at least) rather than being deferred to the contract maturity.  Letting $x_t$ denote the number of futures contracts held at date $t$ and $F^*_t$ the futures price, the cash flow from the contracts is $x_t\\d   F^*_t$.  This is also the change in the value of the portfolio, because marking to market means that the contracts always have zero value.  \n\nTo compare hedging with futures and forwards, assume  there is a constant risk-free rate $r$.  Let $T$ denote the maturity of the futures and forward contracts.  Because there is a constant risk-free rate, we have $P(t,T) = \\mathrm{e}^{-r(T-t)}$, which implies $(\\d  P)(\\d  F) =0$.  Moreover, futures prices equal forward prices.  Thus,\n\n::: Rule\n## \nIf there is a constant risk-free rate $r$, the change in the value of a portfolio of forward contracts at date $t$ is\n$$\nx_t\\mathrm{e}^{-r(T-t)}\\d   F_t\n$$ {#eq-forwardchange100}\n\nand the change in the value of a portfolio of futures contracts is\n$$\nx_t\\d   F_t\\;,\n$$ {#eq-futureschange100}\n\nwhere $x_t$ denotes the number of futures/forward contracts held at date $t$, $T$ is the maturity of the futures and forward contracts and $F_t$ is the futures (= forward) price at date $t$.\n:::\n\nComparing @eq-forwardchange100 and @eq-futureschange100, we see that if $x_t$ is the number of forward contracts that should be held in a hedge, then \n$$\ny_t = \\mathrm{e}^{-r(T-t)}x_t\n$$ {#eq-futuresxy}\n\nis the number of futures contracts that should be held, because with this number of contracts we have\n\\begin{align*}\n\\text{Change in Forward Portfolio} & = x_t\\mathrm{e}^{-r(T-t)}\\d   F_t\\\\\n& = y_t\\d   F_t\\\\\n& = \\text{Change in Futures Portfolio}\\;.\n\\end{align*}\nIn short, we don't require as many futures contracts as forward contracts, and the scaling factor to convert from forwards to futures is just the present value factor $\\mathrm{e}^{-r(T-t)}$.\n\nFor example, the result of @sec-s:replicatingquantos on replicating the payoff $\\bar{X}S_T$ with forward contracts leads to the following:\n\n::: Rule\n## \nTo replicate the payoff $\\bar{X}S_T$ at date $T$, where $\\bar{X}$ is a fixed exchange rate and $S$ is the foreign currency price of an asset, one should invest $V_t$ units of domestic currency in the foreign asset and be short $\\mathrm{e}^{(r_f-r)(T-t)}V_t/X_t$ currency futures at date $t$, where $V_t$ is defined in @eq-quanto2 and $X_t$ is the spot exchange rate.\n:::\n\n\nWe can use @eq-futuresxy to determine how to delta hedge \\index{delta hedge} futures options.  As explained in @sec-s:futuresoptions, assuming non-random interest rates, futures options are more valuable than options on forwards because futures are marked to market upon exercise of an option. Specifically, Black's formulas @eq-black - @eq-black_d2 for options on forwards and @eq-black2 - @eq-black_d22 for options on futures show that the values are the same except for the maturity of the discount bond appearing in the equations.  With a constant risk-free rate $r$, options maturing at $T$ and futures/forwards maturing at $T'$, the relation is\n$$\\text{Value of Futures Option} = \\mathrm{e}^{r(T'-T)} \\times \\text{Value of Forward Option}\\; .$$\nBecause the scaling factor $\\mathrm{e}^{r(T'-T)}$ does not change as time passes, this implies that as time passes we have\n\n$$\n\\begin{multline}\n\\text{Change in Futures Option Value } \\\\= \\mathrm{e}^{r(T'-T)} \\times \\text{Change in Forward Option Value}\\;.\n\\end{multline}\n$$ {#eq-futures1001}\n\nWe can combine  @eq-futuresxy and @eq-futures1001 to convert from a hedge of a forward option using forward contracts, which we discussed in @sec-s:forwardhedging, to a hedge of a futures option using futures contracts.  For example, we concluded in @sec-s:forwardhedging that we should be long $\\mathrm{N}(d_1)$ forwards to hedge a short call option on a forward contract.  Consequently,  @eq-futuresxy shows that we can hedge a short call option on a forward by being long $\\mathrm{e}^{-r(T'-t)}\\mathrm{N}(d_1)$ futures, and then we see from @eq-futures1001  that the hedge for a short call on a futures is being long\n$$\\mathrm{e}^{r(T'-T)}\\mathrm{e}^{-r(T'-t)}\\mathrm{N}(d_1) = \\mathrm{e}^{-r(T-t)}\\mathrm{N}(d_1)$$ \nfutures contracts.\n\nIn @sec-s:forwardhedging, we derived the hedges for forward options by considering them as exchange options.  We can use @eq-changeforwardvalue to confirm that our calculations were correct.  Consider hedging a short call maturing at $T$ on a forward contract maturing at $T'$.  We can assume interest rates vary randomly and use discount bonds in the hedge.  We stated in @sec-s:forwardhedging that we  should hold \n$F_0\\mathrm{N}(d_1)-K\\mathrm{N}(d_2)$\nunits of the discount bond maturing at $T'$  and we should go long \n$\\mathrm{N}(d_1)$ forwards to hedge the short call. \nThis is a zero-cost portfolio when we include the proceeds from selling the call.  Using @eq-changeforwardvalue, we see that the change in the value of the portfolio will be\n$$\n-\\d  C + [F_0\\mathrm{N}(d_1)-K\\mathrm{N}(d_2)]\\d  P + \\mathrm{N}(d_1)[P(0,T')\\d   F + (\\d  P)(\\d  F)]\\;.\n$$ {#eq-forwardhedging1}\n\nThe value of the call at date $t$ will be a function of $t$,  $P(t,T')$ and $F_t$, which we write as $C(t,P,F)$.  From Ito's formula,\n\\begin{align*}\n\\d  C &= \\frac{\\partial C}{\\partial t}\\d   t + \\frac{\\partial C}{\\partial P}\\d   P + \\frac{\\partial C}{\\partial F}\\d   F \\\\  &\\qquad + \\frac{1}{2}\\frac{\\partial^2 C}{\\partial P^2}\\, (\\d  P)^2   + \\frac{1}{2}\\frac{\\partial^2 C}{\\partial F^2}\\, (\\d  F)^2 + \\frac{\\partial^2 C}{\\partial F \\partial P} (\\d  P)(\\d  F)\\;.\\\\\n&=\\Theta\\d   t + \\delta_P\\d   P + \\delta_F\\d   F  + \\frac{1}{2}\\Gamma_{PP} (\\d  P)^2 + \\frac{1}{2}\\Gamma_{FF} (\\d  F)^2  + \\Gamma_{FP}\\,(\\d  P)(\\d  F)\\;,\n\\end{align*}\nwhere the $\\delta$'s and $\\Gamma$'s denote the first and second partial derivatives indicated by the subscripts.  Inserting this formula into @eq-forwardhedging1 and making use of the formulas in the table in @sec-s:forwardhedging, we see that the $\\d  P$ terms cancel because $\\delta_P = F_0\\mathrm{N}(d_1)-K\\mathrm{N}(d_2)$.  Furthermore, the $\\d  F$ terms cancel because $\\delta_F = \\mathrm{N}(d_1)P(0,T')$.  Thus, there is no exposure in the portfolio to the two risky asset prices $P$ and $F$.  Furthermore, $\\Gamma_{PP} = 0$ and the $(\\d  P)(\\d  F)$ terms cancel because $\\Gamma_{FP} = \\mathrm{N}(d_1)$.  These substitutions simplify the change @eq-forwardhedging1 in the value of the portfolio to\n$$-\\Theta\\d   t - \\frac{1}{2}\\Gamma_{FF} (\\d  F)^2  = \\frac{\\sigma P(0,T')F_0\\mathrm{n}d(d_1)}{2\\sqrt{T}}\\d   t  -  \\frac{P(0,T')\\mathrm{n}d(d_1)}{2\\sigma\\sqrt{T}F_0}\\,(\\d  F)^2\\; ,$$\nwhich we can see to be zero because $(\\d  F)^2 = \\sigma^2F^2\\d   t$.\nThus, the hedge is perfect when continuously rebalanced.\n\n## Market Completeness {#sec-s:margrabecomplete}\n\nA formal definition of market completeness \\index{complete market} must specify which state-contin\\-gent claims (random variables depending on the history of prices) can be replicated by trading the marketed assets---for example, one might want all of the claims with finite means to be replicable, or only all of the claims with finite variances, etc.  A formal analysis of market completeness is not presented in this book, except for the binomial and trinomial models in @sec-c:arbitrage.   However, we have stated that stochastic volatility models are incomplete.  This follows intuitively from the fact that a portfolio containing only one risky asset (the underlying) cannot be perfectly correlated with the two Brownian motions that determine the value of a derivative asset (the Brownian motions driving the price of the underlying and its volatility).  In general, a market must include an instantaneously risk-free asset and as many risky assets as there are Brownian motions in order to be complete.  \n\nThe exchange-option model of Margrabe---with two risky assets, two Brownian motions, and no risk-free asset---is obviously incomplete.  \\index{incomplete market} For example, it is impossible to have exactly \\$100 at date $T$.  With no risk-free asset, there is simply no way to store money.  This may seem far-fetched, but we might be interested in payoffs in real (i.e., inflation-adjusted) dollars, in which case the absence of a risk-free asset may be a normal situation.   In any case, we have not assumed a risk-free asset exists, but we have priced options without appealing to equilibrium arguments.  This deserves some clarification.\n\nAs mentioned above, a formal definition of market completeness must specify which contingent claims are to be replicable.  The Margrabe model is complete for a certain set of contingent claims.  Contingent claims of the form $S_2_TX_T$ where $X_T$ is a random variable depending on the relative prices $S_1_t/S_2_t$ for $0 \\leq t\\leq T$ can be replicated.  Likewise,  contingent claims of the form $S_1_TX_T$ can be replicated.  The payoffs of exchange options are of this form, so they can be priced by arbitrage, even though there are other contingent claims (for example, receiving exactly \\$100 at date $T$) that cannot be replicated and hence cannot be priced by arbitrage.  Likewise, the Black and Merton models in which there is a zero-coupon bond but no instantaneously risk-free asset are examples of incomplete markets that are still sufficiently complete to price options by arbitrage (the options can be replicated).  The proof that the Margrabe model is complete in the sense stated here follows from the change of numeraire argument used to derive Margrabe's formula from the Black-Scholes formula (recall that the second asset is risk-free when we use it as the numeraire, so there is a risk-free asset under the new numeraire) and a proof that the Black-Scholes model is complete (which we have omitted, except to show that European options can be replicated).\n\n::: Extra\n ## \n\nWe will conclude with a  proof of the Margrabe formula that does not depend on the Black-Scholes formula.   Let $x$ denote the random variable taking the value 1 when $S_1_T>S_2_T$ and which is 0 otherwise.  Then the value of the exchange option at maturity is $xS_1_T-xS_2_T$.  Let $V_i$ denote the value of the portfolio beginning with $\\mathrm{e}^{-q_iT}$ units of asset $i$ at date $0$ and reinvesting dividends, to accumulate to one share at date $T$.  Then $V_i_T=S_i_T$ and from the fundamental pricing @eq-formula the value at date $0$ of receiving $xS_i_T$ at date $T$ is\n\\begin{align*}\nV_i_0\\\\E^{V_i}\\left[x\\frac{S_i_T}{V_i_T}\\right] &= \\mathrm{e}^{-q_iT}S_i_0\\\\E^{V_i}[x] \\\\\n&= \\mathrm{e}^{-q_iT}S_i_0\\times\\text{prob}^{V_i}\\big(V_1_T>V_2_T\\big)\\; .\n\\end{align*}\nWe can write the value of receiving $xS_1_T$ as\n$$\\mathrm{e}^{-q_1T}S_1_0\\times\\text{prob}^{V_1}\\left(\\frac{V_2_T}{V_1_T} < 1\\right)$$\nand the value of receiving $xS_2_T$ as\n$$\\mathrm{e}^{-q_2T}S_2_0\\times\\text{prob}^{V_2}\\left(\\frac{V_1_T}{V_2_T} > 1\\right)\\;.$$\nNote that $V_2/V_1$ is a martingale when we use $V_1$ as the numeraire and $V_1/V_2$ is a martingale when we use $V_2$ as the numeraire.  Because they are martingales, they have no drifts.  The volatility of the ratios is given in @eq-margrabesigma.  Therefore, we have\n\\begin{align*}\n\\frac{\\d  (V_2/V_1)}{V_2/V_1} &= \\sigma \\d   B^*_1,\\\\\n\\frac{\\d  (V_1/V_2)}{V_1/V_2} &= \\sigma \\d   B^*_2,\n\\end{align*}\nwhere $B^*_i$ is a Brownian motion when $V_i$ is used as the numeraire.  Margrabe's formula now follows from the tail probability formulas @eq-tailprob01--@eq-tailprob02.  \n:::\n\n\n\n## {.unnumbered}\n\n::: Exercise\n Derive the Greeks of a call option on a futures contract.\n:::\n::: Exercise\n Using the results of the previous exercise, show that the delta hedge of a written call on a futures contract that consists of $\\mathrm{e}^{-r(T-t)}\\mathrm{N}(d_1)$ long futures contracts and the value of the call invested in the risk-free asset is a riskless hedge.\n:::\n::: Exercise\n Derive a formula (like put-call parity) for the value of an option to exchange asset~1 for asset~2 in terms of the value of an option to do the reverse exchange.\n:::\n::: Exercise\n Create a Python function `Black_Call_Implied_Vol` that uses bisection to compute an implied forward price volatility from Black's formula and the market price of a call option on a forward.\n:::\n::: Exercise\n Using a synthetic forward argument, derive the forward price for a forward contract on a stock, where the forward matures at $T'$ and the stock pays a single known cash dividend $D$ at date $T<T'$.\n:::\n::: Exercise\n Using the result of the previous exercise and Black's formula, derive a formula for the value of a European call option on a stock that pays a single known cash dividend before the option matures.\n:::\n::: Exercise\n Modify the function `Simulated_Delta_Hedge_Profits` to compute the percentiles of gains and losses for an investor who writes a call option on a forward contract and uses a discretely-rebalanced delta hedge.  As in @exr-e_forwardhedging, you will need to create a variable to keep track of the net asset/liability from trading forwards and include it in the valuation at date $T$.\n:::\n::: Exercise\n Consider the portfolio that promises to pay $\\bar{X}S_T$ at date $T$ and replicates the payoff using currency forwards described in @sec-s:replicatingquantos, where $\\bar{X}$ is a fixed exchange rate and $S$ is the foreign currency price of an asset.  Using @eq-changeforwardvalue of gains and losses from trading forwards, verify that the portfolio is riskless.\n:::\n::: Exercise\n Repeat the previous exercise using the futures hedge described in @sec-s:hedgingforwards.\n:::\n::: Exercise\n It has been observed empirically that implied volatilities of stocks are upward biased estimates of future volatility.  Given that there is not really a constant risk-free rate, implied volatilities should be interpreted as implied forward-price volatilities, whereas the empirical literature has measured future volatility as the subsequent volatility of the stock.  What assumptions about bond volatilities and the correlation of bonds and stocks could explain the empirical finding; i.e., what assumptions imply that the volatility of the forward price exceeds the volatility of the stock?\n:::\n::: Exercise\n In the continuous-time Ho-Lee model described in @sec-c:vasicek, the volatility of a discount bond with time $\\tau$ to maturity is $\\sigma_r\\tau$ for a constant $\\sigma_r$.  Under this assumption, calculate the average volatility of the forward price of a stock from date $0$ to date $T$, where $T$ is the maturity of the forward contract.  Assume the stock has a constant volatility $\\sigma_s$ and the correlation between the stock and bond is a constant $\\rho$.\n:::\n::: Exercise\n Making the same assumptions as in the previous exercise, and using the result of that exercise and Merton's formula, write a Python function to calculate the value of a call option on a stock.  The inputs should be $S$, $K$, $P$, $\\sigma_s$, $\\sigma_r$, $\\rho$, $q$, and $T$.\n:::\n\n",
    "supporting": [
      "Chapter_Merton_files\\figure-pdf"
    ],
    "filters": []
  }
}